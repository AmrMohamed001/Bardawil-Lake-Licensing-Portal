<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= title %> - منصة تراخيص بحيرة البردويل
  </title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/pages/application-details.css">
  <link rel="icon" type="image/png" href="/imgs/logo.png">
</head>

<body>
  <%- include('../partials/spinner') %>
    <%- include('../partials/navbar') %>

      <div class="details-page">
        <div class="container">
          <!-- Breadcrumb -->
          <nav class="breadcrumb">
            <a href="/dashboard" class="breadcrumb-link">
              <i class="fas fa-home"></i>
              <span>لوحة التحكم</span>
            </a>
            <i class="fas fa-chevron-left breadcrumb-separator"></i>
            <span class="breadcrumb-current">تفاصيل الطلب</span>
          </nav>

          <!-- Page Header -->
          <div class="page-header">
            <div class="header-info">
              <h1>
                <span class="header-icon"><i class="fas fa-file-alt"></i></span>
                طلب رقم <%= application.applicationNumber %>
              </h1>
              <p class="header-meta">
                <i class="far fa-calendar-alt"></i>
                <span>تاريخ التقديم: <%= new Date(application.createdAt).toLocaleDateString('ar-EG') %></span>
              </p>
            </div>
            <div class="header-badge">
              <%- include('../partials/status-badge', { status: application.status, statusInfo: application.statusInfo
                }) %>
            </div>
          </div>

          <div class="content-grid">

            <!-- Status Messages (Moved Up) -->
            <% if (['payment_verified', 'ready' , 'completed' , 'rejected' ].includes(application.status)) { %>
              <div class="status-messages-wrapper" style="grid-column: 1 / -1; margin-bottom: 0;">

                <% if (application.status==='payment_verified' ) { %>
                  <div class="status-message success">
                    <i class="fas fa-check-circle"></i>
                    <div>
                      <p>تم تأكيد الدفع بنجاح!</p>
                      <span style="font-size: 0.9em; opacity: 0.8;">جاري إعداد رخصتك، سيتم إشعارك عند جاهزيتها
                        للاستلام</span>
                    </div>
                  </div>
                  <% } else if (application.status==='ready' ) { %>
                    <div class="status-message ready">
                      <i class="fas fa-gift"></i>
                      <div>
                        <p>الرخصة جاهزة للاستلام!</p>
                        <span style="font-size: 0.9em; opacity: 0.8;">يرجى التوجه إلى مقر الجهاز لاستلام رخصتك خلال
                          أوقات العمل الرسمية</span>
                      </div>
                    </div>
                    <% } else if (application.status==='completed' ) { %>
                      <div class="status-message completed">
                        <i class="fas fa-trophy"></i>
                        <div>
                          <p>تم استلام الرخصة بنجاح!</p>
                          <span style="font-size: 0.9em; opacity: 0.8;">شكراً لاستخدامك منصة تراخيص بحيرة البردويل.
                            نتمنى لك موسم صيد موفق!</span>
                        </div>
                      </div>
                      <% } %>

                        <!-- Rejection Message -->
                        <% if (application.status==='rejected' && application.rejectionReason) { %>
                          <div class="status-message error"
                            style="background: #ffebee; color: #c62828; border: 1px solid #ef5350;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                              <p>تم رفض الطلب</p>
                              <span style="font-size: 0.9em; opacity: 0.8;">
                                <%= application.rejectionReason %>
                              </span>
                            </div>
                          </div>
                          <% } %>

              </div>
              <% } %>

                <!-- Application Info Card -->
                <div class="card info-card">
                  <h3><i class="fas fa-info-circle"></i> معلومات الطلب</h3>
                  <div class="info-grid">
                    <div class="info-item">
                      <span class="label">
                        <i class="fas fa-tag"></i> نوع الترخيص
                      </span>
                      <span class="value">
                        <% if (application.applicationType==='fisherman' ) { %>
                          <span class="license-badge fisherman"><i class="fas fa-fish"></i> ترخيص صياد</span>
                          <% } else if (application.applicationType==='boat' ) { %>
                            <span class="license-badge boat"><i class="fas fa-ship"></i> ترخيص مركب</span>
                            <% } else if (application.applicationType==='vehicle' ) { %>
                              <span class="license-badge vehicle"><i class="fas fa-truck"></i> ترخيص سيارة</span>
                              <% } else if (application.applicationType==='trade' ) { %>
                                <span class="license-badge trade"><i class="fas fa-store"></i> ترخيص تجارة</span>
                                <% } else if (application.applicationType==='entry' ) { %>
                                  <span class="license-badge entry"><i class="fas fa-door-open"></i> ترخيص دخول</span>
                                  <% } else { %>
                                    <%= application.applicationType %>
                                      <% } %>
                      </span>
                    </div>

                    <div class="info-item">
                      <span class="label">
                        <i class="fas fa-layer-group"></i> الفئة
                      </span>
                      <span class="value">
                        <%= application.licenseCategory %>
                      </span>
                    </div>

                    <div class="info-item">
                      <span class="label">
                        <i class="fas fa-sync-alt"></i> نوع الطلب
                      </span>
                      <span class="value">
                        <span class="request-type <%= application.isRenewal ? 'renewal' : 'new' %>">
                          <%= application.isRenewal ? 'تجديد' : 'جديد' %>
                        </span>
                      </span>
                    </div>

                    <% if (application.paymentAmount) { %>
                      <div class="info-item highlight">
                        <span class="label">
                          <i class="fas fa-coins"></i> مبلغ الرسوم
                        </span>
                        <span class="value amount">
                          <%= application.paymentAmount %> <small>جنيه</small>
                        </span>
                      </div>
                      <% } %>
                  </div>
                </div>

                <!-- Timeline Card -->
                <div class="card timeline-card">
                  <h3><i class="fas fa-history"></i> مراحل الطلب</h3>
                  <div class="timeline">
                    <% timelineSteps.forEach(step=> { %>
                      <div class="timeline-item <%= step.status %>">
                        <div class="timeline-dot">
                          <% if (step.status==='completed' ) { %>
                            <i class="fas fa-check" style="font-size: 10px; color: white;"></i>
                            <% } else if (step.status==='active' ) { %>
                              <div style="width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
                              <% } %>
                        </div>
                        <div class="timeline-content">
                          <% if (step.date) { %>
                            <span class="timeline-date">
                              <%= new Date(step.date).toLocaleDateString('ar-EG') %>
                            </span>
                            <% } %>
                              <p><strong>
                                  <%= step.title %>
                                </strong></p>
                              <% if (step.description && (step.status==='completed' || step.status==='active' )) { %>
                                <p class="timeline-desc">
                                  <%= step.description %>
                                </p>
                                <% } %>
                        </div>
                      </div>
                      <% }); %>

                        <!-- Rejected Status -->
                        <% if (application.status==='rejected' ) { %>
                          <div class="timeline-item rejected">
                            <div class="timeline-dot" style="background: #f44336;">
                              <i class="fas fa-times" style="font-size: 10px; color: white;"></i>
                            </div>
                            <div class="timeline-content">
                              <p style="color: #f44336;"><strong>تم رفض الطلب ❌</strong></p>
                              <% if (application.rejectionReason) { %>
                                <p class="timeline-desc">
                                  <%= application.rejectionReason %>
                                </p>
                                <% } %>
                            </div>
                          </div>
                          <% } %>
                  </div>
                </div>

                <!-- Personal Data Card -->
                <div class="card data-card">
                  <h3><i class="fas fa-user-circle"></i> البيانات الشخصية</h3>
                  <div class="info-grid">
                    <div class="info-item">
                      <span class="label"><i class="fas fa-user"></i> الاسم</span>
                      <span class="value">
                        <%= user.firstNameAr %>
                          <%= user.lastNameAr %>
                      </span>
                    </div>
                    <div class="info-item">
                      <span class="label"><i class="fas fa-id-card"></i> الرقم القومي</span>
                      <span class="value">
                        <%= user.nationalId %>
                      </span>
                    </div>
                    <div class="info-item">
                      <span class="label"><i class="fas fa-phone"></i> رقم الهاتف</span>
                      <span class="value">
                        <%= user.phone %>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Additional Data Card -->
                <% if (applicationData && Object.keys(applicationData).length> 0) { %>
                  <div class="card data-card">
                    <h3><i class="fas fa-clipboard-list"></i> البيانات الإضافية</h3>
                    <div class="info-grid">

                      <% if (applicationData.unionCardNumber) { %>
                        <div class="info-item">
                          <span class="label"><i class="fas fa-id-badge"></i> رقم البطاقة النقابية</span>
                          <span class="value">
                            <%= applicationData.unionCardNumber %>
                          </span>
                        </div>
                        <% } %>

                          <% if (applicationData.marina) { %>
                            <div class="info-item">
                              <span class="label"><i class="fas fa-anchor"></i> المرسى</span>
                              <span class="value">
                                <%= applicationData.marina %>
                              </span>
                            </div>
                            <% } %>

                              <% if (applicationData.previousLicenseNumber) { %>
                                <div class="info-item">
                                  <span class="label"><i class="fas fa-file-contract"></i> رقم الرخصة السابقة</span>
                                  <span class="value">
                                    <%= applicationData.previousLicenseNumber %>
                                  </span>
                                </div>
                                <% } %>

                                  <% if (applicationData.boatNumber) { %>
                                    <div class="info-item">
                                      <span class="label"><i class="fas fa-hashtag"></i> رقم الصال</span>
                                      <span class="value">
                                        <%= applicationData.boatNumber %>
                                      </span>
                                    </div>
                                    <% } %>

                                      <% if (applicationData.boatRegistration) { %>
                                        <div class="info-item">
                                          <span class="label"><i class="fas fa-certificate"></i> رقم تسجيل المركب</span>
                                          <span class="value">
                                            <%= applicationData.boatRegistration %>
                                          </span>
                                        </div>
                                        <% } %>

                                          <% if (applicationData.boatLength) { %>
                                            <div class="info-item">
                                              <span class="label"><i class="fas fa-ruler-horizontal"></i> طول
                                                المركب</span>
                                              <span class="value">
                                                <%= applicationData.boatLength %> متر
                                              </span>
                                            </div>
                                            <% } %>

                                              <% if (applicationData.enginePower) { %>
                                                <div class="info-item">
                                                  <span class="label"><i class="fas fa-tachometer-alt"></i> قوة
                                                    المحرك</span>
                                                  <span class="value">
                                                    <%= applicationData.enginePower %> حصان
                                                  </span>
                                                </div>
                                                <% } %>

                                                  <% if (applicationData.plateNumber) { %>
                                                    <div class="info-item">
                                                      <span class="label"><i class="fas fa-car"></i> رقم لوحة
                                                        السيارة</span>
                                                      <span class="value">
                                                        <%= applicationData.plateNumber %>
                                                      </span>
                                                    </div>
                                                    <% } %>

                                                      <% if (applicationData.vehicleModel) { %>
                                                        <div class="info-item">
                                                          <span class="label"><i class="fas fa-cogs"></i> موديل
                                                            السيارة</span>
                                                          <span class="value">
                                                            <%= applicationData.vehicleModel %>
                                                          </span>
                                                        </div>
                                                        <% } %>

                                                          <% if (applicationData.previousBoatNumber) { %>
                                                            <div class="info-item">
                                                              <span class="label"><i class="fas fa-history"></i> رقم
                                                                المركب
                                                                السابق</span>
                                                              <span class="value">
                                                                <%= applicationData.previousBoatNumber %>
                                                              </span>
                                                            </div>
                                                            <% } %>

                    </div>
                  </div>
                  <% } %>

                    <!-- Documents Card -->
                    <% if (application.documents && application.documents.length> 0) { %>
                      <div class="card documents-card full-width">
                        <h3><i class="fas fa-folder-open"></i> المستندات المرفقة</h3>
                        <div class="documents-list">
                          <% application.documents.forEach(doc=> {
                            let docPath = doc.filePath || '';
                            docPath = docPath.replace(/\\/g, '/');
                            if (docPath.startsWith('src/public/')) docPath = docPath.replace('src/public/', '/');
                            else if (docPath.startsWith('public/')) docPath = docPath.replace('public/', '/');
                            if (!docPath.startsWith('/')) docPath = '/' + docPath;
                            if ((docPath === '/' || docPath === '') && doc.fileName) {
                            docPath = '/uploads/' + doc.fileName;
                            }
                            const isPdf = doc.mimeType === 'application/pdf';
                            %>
                            <div class="document-item">
                              <div class="doc-info">
                                <i class="<%= isPdf ? 'fas fa-file-pdf' : 'fas fa-image' %>"></i>
                                <span>
                                  <%= doc.originalName || doc.fileName %>
                                </span>
                              </div>
                              <a href="<%= docPath %>" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> <span>عرض</span>
                              </a>
                            </div>
                            <% }); %>
                        </div>
                      </div>
                      <% } %>

          </div>

          <!-- Payment Required Section -->
          <% if (application.status==='approved_payment_pending' ) { %>
            <div class="payment-required-card">
              <div class="payment-icon">
                <i class="fas fa-wallet"></i>
              </div>
              <div class="payment-info">
                <h3>مطلوب دفع الرسوم</h3>
                <p>تمت الموافقة على طلبك بنجاح! يرجى دفع الرسوم لإتمام الإجراءات</p>

                <% if (application.paymentAmount) { %>
                  <div class="payment-amount">
                    <span class="amount">
                      <%= application.paymentAmount %>
                    </span>
                    <span class="currency">جنيه مصري</span>
                  </div>
                  <% } %>

                    <div class="bank-info"
                      style="margin-top: 1.5rem; padding: 1rem; background: #e3f2fd; border-radius: 8px; border: 1px solid #90caf9;">
                      <p style="margin-bottom: 0.5rem; font-weight: 600; color: #1565c0; font-size: 0.9rem;">
                        <i class="fas fa-university"></i> حساب جهاز مستقبل مصر للتنمية المستدامة:
                      </p>
                      <div
                        style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
                        <p class="account-number"
                          style="font-family: monospace; font-size: 1.1rem; font-weight: 700; color: #0d47a1; margin: 0; direction: ltr;">
                          <%= bankAccount %>
                        </p>
                        <button class="copy-btn" onclick="copyAccountNumber('<%= bankAccount %>')"
                          style="background: white; border: 1px solid #bbdefb; border-radius: 4px; padding: 4px 8px; cursor: pointer; color: #1565c0;">
                          <i class="fas fa-copy"></i>
                        </button>
                      </div>
                    </div>
              </div>

              <div class="payment-actions">
                <a href="/payment/<%= application.id %>" class="btn-pay">
                  <i class="fas fa-upload"></i>
                  <span>رفع إيصال السداد</span>
                </a>
                <p class="payment-note">
                  <i class="fas fa-info-circle"></i>
                  قم بالتحويل البنكي ثم ارفع صورة الإيصال
                </p>
              </div>
            </div>
            <% } %>



              <!-- Action Buttons -->
              <div class="actions-bar" style="justify-content: center; margin-top: 2rem;">
                <a href="/dashboard" class="btn-secondary"
                  style="border: 1px solid #1e3c72; color: #1e3c72; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s;">
                  <i class="fas fa-arrow-right"></i>
                  <span>العودة للوحة التحكم</span>
                </a>
              </div>

        </div>
      </div>

      <%- include('../partials/footer') %>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
        <script src="/js/main.js"></script>
        <script>
          // Copy account number function
          function copyAccountNumber(accountNumber) {
            if (!accountNumber) accountNumber = '5170199000001735';
            navigator.clipboard.writeText(accountNumber).then(() => {
              const btn = event.target.closest('.copy-btn');
              const originalHTML = btn.innerHTML;
              btn.innerHTML = '<i class="fas fa-check"></i>';
              btn.style.background = '#4CAF50';
              btn.style.color = 'white';
              btn.style.borderColor = '#4CAF50';

              setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = 'white';
                btn.style.color = '#1565c0';
                btn.style.borderColor = '#bbdefb';
              }, 2000);
            }).catch(err => {
              console.error('Failed to copy:', err);
            });
          }
        </script>
</body>

</html>