<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="icon" type="image/png" href="/imgs/logo.png">
    <title>
        <%= title %> - بوابة بحيرة البردويل
    </title>
</head>

<body>
    <%- include('../partials/navbar') %>

        <main class="main-content">
            <div class="container">
                <!-- Header -->
                <div class="page-header d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-receipt"></i>
                            المدفوعات المعلقة
                        </h1>
                        <p class="page-subtitle">
                            مراجعة والتحقق من إيصالات الدفع المرفوعة
                        </p>
                    </div>
                    <a href="/financial/dashboard" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-right"></i> لوحة التحكم
                    </a>
                </div>

                <!-- Search & Filters -->
                <div class="filters-bar card mb-4">
                    <div class="card-body">
                        <form method="GET" class="search-form" style="display: flex; gap: 1rem;">
                            <div class="search-input-group flex-grow-1">
                                <input type="text" class="form-control" name="search"
                                    placeholder="بحث برقم الطلب، الرقم القومي، أو الاسم..." value="<%= search || '' %>">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                                بحث
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Payments Table -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h3 class="card-title h5 mb-0">الطلبات المعلقة (<%= pagination.total %>)</h3>
                    </div>
                    <div class="card-body p-0">
                        <% if (applications.length===0) { %>
                            <div class="empty-state text-center p-5">
                                <i class="fas fa-check-circle text-success"
                                    style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h3>لا توجد مدفوعات معلقة</h3>
                                <p class="text-muted">جميع المدفوعات قد تم التحقق منها</p>
                            </div>
                            <% } else { %>
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>رقم الطلب</th>
                                                <th>اسم المتقدم</th>
                                                <th>الرقم القومي</th>
                                                <th>تاريخ الرفع</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% applications.forEach(app=> { %>
                                                <tr>
                                                    <td>
                                                        <span class="badge bg-info text-dark">
                                                            <%= app.applicationNumber %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <%= app.applicant.firstNameAr %>
                                                            <%= app.applicant.lastNameAr %>
                                                    </td>
                                                    <td><span style="font-family: monospace;">
                                                            <%= app.applicant.nationalId %>
                                                        </span></td>
                                                    <td>
                                                        <%= new Date(app.updatedAt).toLocaleDateString('ar-EG') %>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-primary"
                                                            onclick="viewPaymentDetails('<%= app.id %>')">
                                                            <i class="fas fa-eye"></i>
                                                            مراجعة
                                                        </button>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <% if (pagination.pages> 1) { %>
                                    <div class="card-footer bg-white">
                                        <nav aria-label="Page navigation">
                                            <ul class="pagination justify-content-center mb-0">
                                                <% for(let i=1; i <=pagination.pages; i++) { %>
                                                    <li class="page-item <%= pagination.page === i ? 'active' : '' %>">
                                                        <a class="page-link" href="?page=<%= i %>&search=<%= search %>">
                                                            <%= i %>
                                                        </a>
                                                    </li>
                                                    <% } %>
                                            </ul>
                                        </nav>
                                    </div>
                                    <% } %>
                                        <% } %>
                    </div>
                </div>
            </div>
        </main>

        <!-- Payment Details Modal -->
        <div id="paymentModal" class="modal-overlay">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title">تفاصيل الدفع</h2>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body" id="modalBody">
                    <div class="text-center p-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                        <p class="mt-2">جاري التحميل...</p>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .main-content {
                padding: 2rem 0;
                background: #f8f9fa;
                min-height: 100vh;
            }

            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                display: none;
                align-items: center;
                justify-content: center;
            }

            .modal-overlay.active {
                display: flex;
            }

            .modal-container {
                background: white;
                width: 90%;
                max-width: 800px;
                border-radius: 12px;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            }

            .modal-header {
                padding: 1.5rem;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-title {
                margin: 0;
                font-size: 1.25rem;
            }

            .modal-close {
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #7f8c8d;
            }

            .modal-body {
                padding: 1.5rem;
                overflow-y: auto;
            }

            /* Detailed Modal Styles */
            .details-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                margin-bottom: 2rem;
                background: #f8f9fa;
                padding: 1rem;
                border-radius: 8px;
            }

            .detail-item {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }

            .detail-item label {
                color: #7f8c8d;
                font-size: 0.85rem;
            }

            .detail-item span {
                font-weight: 600;
                color: #2c3e50;
            }

            .document-preview {
                margin-bottom: 2rem;
                text-align: center;
            }

            .receipt-image {
                max-width: 100%;
                max-height: 400px;
                border-radius: 8px;
                cursor: zoom-in;
                border: 1px solid #ddd;
            }

            .verification-actions {
                border-top: 1px solid #eee;
                padding-top: 1.5rem;
            }

            .action-buttons {
                display: flex;
                gap: 1rem;
                margin-top: 1rem;
            }

            .action-buttons button {
                flex: 1;
            }

            .badge {
                padding: 0.5em 0.75em;
                border-radius: 0.25rem;
            }

            .bg-info {
                background-color: #0dcaf0 !important;
            }
        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
        <script src="/js/financial.js"></script>
        <%- include('../partials/footer') %>
</body>

</html>