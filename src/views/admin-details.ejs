<% layout('admin-layout') -%>
<div class="p-6 md:p-10">
  <div class="mb-6 flex items-center justify-between">
    <div class="flex items-center gap-2 text-sm text-gray-500">
      <a href="/admin-dashboard" class="hover:text-primary">ููุญุฉ ุงูุฅุฏุงุฑุฉ</a>
      <span>/</span>
      <span class="text-gray-800 font-semibold">ุชูุงุตูู ุงูุทูุจ #<%= application.applicationNumber %></span>
    </div>
    
    <a href="/admin-dashboard" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 text-sm font-medium">
      ุนูุฏุฉ ูููุงุฆูุฉ
    </a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    
    <!-- Main Details -->
    <div class="md:col-span-2 space-y-6">
      
      <!-- Application Info -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="bg-primary px-6 py-4 border-b border-primary text-white flex justify-between items-center">
          <h2 class="font-bold text-lg">ุจูุงูุงุช ุงูุทูุจ</h2>
          <%- include('partials/status-badge', { status: application.status }) %>
        </div>
        <div class="p-6 grid grid-cols-2 gap-y-4 text-sm">
          <div>
            <p class="text-gray-500">ููุน ุงูุชุฑุฎูุต</p>
            <p class="font-bold text-gray-800"><%= application.applicationType %></p>
          </div>
          <div>
            <p class="text-gray-500">ุงููุฆุฉ</p>
            <p class="font-bold text-gray-800"><%= application.licenseCategory %></p>
          </div>
          <div>
            <p class="text-gray-500">ุชุงุฑูุฎ ุงูุชูุฏูู</p>
            <p class="font-bold text-gray-800"><%= new Date(application.createdAt).toLocaleDateString('ar-EG') %></p>
          </div>
          <div>
            <p class="text-gray-500">ุฑูู ุฃูุฑ ุงูุชูุฑูุฏ</p>
            <p class="font-bold text-gray-800"><%= application.supplyOrderId || '-' %></p>
          </div>
          <% if (application.paymentAmount) { %>
          <div>
            <p class="text-gray-500">ุงููุจูุบ ุงููุทููุจ</p>
            <p class="font-bold text-accent"><%= application.paymentAmount %> ุฌ.ู</p>
          </div>
          <% } %>
          <% if (application.rejectionReason) { %>
          <div class="col-span-2">
            <p class="text-gray-500">ุณุจุจ ุงูุฑูุถ</p>
            <p class="font-bold text-red-600"><%= application.rejectionReason %></p>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Documents Viewer -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
          <h2 class="font-bold text-lg text-gray-800">ุงููุฑููุงุช</h2>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <% if (application.documents && application.documents.length > 0) { %>
            <% application.documents.forEach(doc => { %>
            <div class="border rounded-lg p-2 <%= doc.documentType === 'payment_receipt' ? 'border-yellow-400 bg-yellow-50' : '' %>">
              <p class="text-xs font-bold <%= doc.documentType === 'payment_receipt' ? 'text-yellow-700' : 'text-gray-500' %> mb-2"><%= doc.documentType %></p>
              <% if (doc.filePath.match(/\.(jpg|jpeg|png|gif)$/i)) { %>
                <img src="/uploads/<%= doc.filePath %>" class="w-full h-48 object-cover rounded cursor-pointer hover:opacity-90 transition" onclick="window.open(this.src)">
              <% } else { %>
                <a href="/uploads/<%= doc.filePath %>" target="_blank" class="flex items-center justify-center h-48 bg-gray-100 rounded hover:bg-gray-200 transition">
                  <span class="text-primary font-semibold">ุนุฑุถ ุงููุณุชูุฏ</span>
                </a>
              <% } %>
            </div>
            <% }) %>
          <% } else { %>
            <div class="col-span-2 text-center py-8 text-gray-500">ูุง ุชูุฌุฏ ูุฑููุงุช</div>
          <% } %>
        </div>
      </div>

      <!-- Status History -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
          <h2 class="font-bold text-lg text-gray-800">ุณุฌู ุงูุญุงูุฉ</h2>
        </div>
        <div class="p-6">
          <% if (application.statusHistory && application.statusHistory.length > 0) { %>
            <div class="space-y-4">
              <% application.statusHistory.forEach(history => { %>
              <div class="flex gap-4 items-start">
                <div class="w-3 h-3 bg-primary rounded-full mt-1.5"></div>
                <div class="flex-1">
                  <p class="font-semibold text-gray-800">
                    <%= history.oldStatus || 'ุฌุฏูุฏ' %> โ <%= history.newStatus %>
                  </p>
                  <p class="text-sm text-gray-500"><%= history.notes || '' %></p>
                  <p class="text-xs text-gray-400 mt-1">
                    <%= new Date(history.changedAt).toLocaleString('ar-EG') %>
                    <% if (history.changedByUser) { %>
                      - ุจูุงุณุทุฉ <%= history.changedByUser.firstNameAr %> <%= history.changedByUser.lastNameAr %>
                    <% } %>
                  </p>
                </div>
              </div>
              <% }) %>
            </div>
          <% } else { %>
            <p class="text-center text-gray-500">ูุง ููุฌุฏ ุณุฌู ุญุงูุฉ</p>
          <% } %>
        </div>
      </div>
      
    </div>

    <!-- Actions Sidebar -->
    <div class="space-y-6">
      
      <!-- Applicant Info -->
      <div class="bg-white rounded-xl shadow-sm p-6 text-center">
        <div class="w-20 h-20 bg-gray-200 rounded-full mx-auto mb-4 overflow-hidden">
          <img src="<%= application.applicant?.profilePicture || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(application.applicant?.firstNameAr || 'User') %>" class="w-full h-full object-cover">
        </div>
        <h3 class="font-bold text-gray-800"><%= application.applicant?.firstNameAr %> <%= application.applicant?.lastNameAr %></h3>
        <p class="text-sm text-gray-500"><%= application.applicant?.nationalId %></p>
        <p class="text-sm text-gray-500 mt-1"><%= application.applicant?.phone %></p>
      </div>

      <!-- Action Buttons (Dynamic based on status) -->
      <div class="bg-white rounded-xl shadow-sm p-6 space-y-3">
        <h3 class="font-bold text-gray-800 mb-2 text-sm">ุงูุฅุฌุฑุงุกุงุช ุงููุชุงุญุฉ</h3>
        
        <% if (application.status === 'received') { %>
          <button onclick="startReview('<%= application.id %>')" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition">๐ ุจุฏุก ุงููุฑุงุฌุนุฉ</button>
        <% } %>

        <% if (application.status === 'under_review') { %>
          <button onclick="approveApplication('<%= application.id %>')" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition">โ ูุจูู ุงูุทูุจ</button>
          <button onclick="showRejectModal('<%= application.id %>')" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition">โ ุฑูุถ ุงูุทูุจ</button>
        <% } %>

        <% if (application.status === 'approved_payment_required') { %>
          <button onclick="verifyPayment('<%= application.id %>')" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition">๐ฐ ุชุฃููุฏ ุงุณุชูุงู ุฅูุตุงู ุงูุฏูุน</button>
          <div class="bg-amber-50 p-3 rounded text-sm text-amber-700">
            ุจุงูุชุธุงุฑ ุฏูุน ุงููุชูุฏู ูู ุงููุณู ุงููุงูู
          </div>
          <button onclick="downloadSupplyOrder('<%= application.id %>')" class="w-full py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-bold transition">ุทุจุงุนุฉ ุฃูุฑ ุงูุชูุฑูุฏ</button>
        <% } %>

        <% if (application.status === 'payment_verified') { %>
          <button onclick="markReady('<%= application.id %>')" class="w-full py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg font-bold transition">๐ฆ ุงูุฑุฎุตุฉ ุฌุงูุฒุฉ ููุงุณุชูุงู</button>
          <div class="bg-green-50 p-3 rounded text-sm text-green-700">
            ุชู ุงูุชุญูู ูู ุงูุฏูุน - ุฌุงุฑู ุฅุนุฏุงุฏ ุงูุฑุฎุตุฉ
          </div>
        <% } %>

        <% if (application.status === 'ready') { %>
          <button onclick="completeApplication('<%= application.id %>')" class="w-full py-2 bg-accent hover:bg-teal-700 text-white rounded-lg font-bold transition">๐ ุชู ุชุณููู ุงูุฑุฎุตุฉ</button>
          <div class="bg-teal-50 p-3 rounded text-sm text-teal-700">
            ุงูุฑุฎุตุฉ ุฌุงูุฒุฉ - ุจุงูุชุธุงุฑ ุชุณููููุง ูููุชูุฏู
          </div>
        <% } %>

        <% if (application.status === 'completed') { %>
          <div class="bg-green-50 p-3 rounded text-sm text-green-700 font-bold text-center">
            โจ ุชู ุชุณููู ุงูุชุฑุฎูุต ุจูุฌุงุญ
          </div>
          <button onclick="printLicense('<%= application.id %>')" class="w-full py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-bold transition">ุทุจุงุนุฉ ุงูุดูุงุฏุฉ</button>
        <% } %>

        <% if (application.status === 'rejected') { %>
          <div class="bg-red-50 p-3 rounded text-sm text-red-700 font-bold text-center">
            โ ุชู ุฑูุถ ูุฐุง ุงูุทูุจ
          </div>
        <% } %>
      </div>

      <!-- Pricing Info -->
      <% if (application.paymentAmount) { %>
      <div class="bg-white rounded-xl shadow-sm p-6">
        <p class="text-sm text-gray-500">ูููุฉ ุงูุฑุณูู</p>
        <p class="text-2xl font-bold text-accent"><%= application.paymentAmount %> ุฌ.ู</p>
      </div>
      <% } %>

    </div>
  </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
    <h3 class="text-lg font-bold text-gray-800 mb-4">ุณุจุจ ุงูุฑูุถ</h3>
    <textarea id="rejectReason" rows="4" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary" placeholder="ุงูุชุจ ุณุจุจ ุงูุฑูุถ..."></textarea>
    <div class="flex gap-3 mt-4">
      <button onclick="confirmReject()" class="flex-1 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition">ุชุฃููุฏ ุงูุฑูุถ</button>
      <button onclick="hideRejectModal()" class="flex-1 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-bold transition">ุฅูุบุงุก</button>
    </div>
  </div>
</div>

<script>
  let currentRejectId = null;

  const api = axios.create({
    baseURL: '/api/v1',
    withCredentials: true
  });

  const startReview = async (id) => {
    if(!confirm('ูู ุชุฑูุฏ ุจุฏุก ูุฑุงุฌุนุฉ ูุฐุง ุงูุทูุจุ')) return;
    try {
      const res = await api.put('/admin/applications/' + id + '/review');
      if(res.data.status === 'success') location.reload();
    } catch(err) { alert(err.response?.data?.message || 'ุฎุทุฃ'); }
  };

  const approveApplication = async (id) => {
    if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุจูู ุงูุทูุจ ูุฅุตุฏุงุฑ ุฃูุฑ ุงูุชูุฑูุฏุ')) return;
    try {
      const res = await api.post('/admin/applications/' + id + '/approve');
      if(res.data.status === 'success') location.reload();
    } catch(err) { alert(err.response?.data?.message || 'ุฎุทุฃ'); }
  };

  const showRejectModal = (id) => {
    currentRejectId = id;
    document.getElementById('rejectModal').classList.remove('hidden');
    document.getElementById('rejectModal').classList.add('flex');
  };

  const hideRejectModal = () => {
    currentRejectId = null;
    document.getElementById('rejectModal').classList.add('hidden');
    document.getElementById('rejectModal').classList.remove('flex');
    document.getElementById('rejectReason').value = '';
  };

  const confirmReject = async () => {
    const reason = document.getElementById('rejectReason').value.trim();
    if (!reason) {
      alert('ูุฌุจ ุฅุฏุฎุงู ุณุจุจ ุงูุฑูุถ');
      return;
    }
    try {
      const res = await api.post('/admin/applications/' + currentRejectId + '/reject', { reason });
      if(res.data.status === 'success') location.reload();
    } catch(err) { alert(err.response?.data?.message || 'ุฎุทุฃ'); }
  };
  
  const verifyPayment = async (id) => {
    if(!confirm('ูู ุงุณุชููุช ูุตู ุงุณุชูุงู ููุฏูุฉ ูุชู ุงูุชุญูู ูู ุตุญุชูุ')) return;
    try {
      const res = await api.put('/admin/applications/' + id + '/verify-payment');
      if(res.data.status === 'success') location.reload();
    } catch(err) { alert(err.response?.data?.message || 'ุฎุทุฃ'); }
  };

  const markReady = async (id) => {
    if(!confirm('ูู ุงูุฑุฎุตุฉ ุฌุงูุฒุฉ ููุงุณุชูุงูุ')) return;
    try {
      const res = await api.put('/admin/applications/' + id + '/ready');
      if(res.data.status === 'success') location.reload();
    } catch(err) { alert(err.response?.data?.message || 'ุฎุทุฃ'); }
  };

  const completeApplication = async (id) => {
    if(!confirm('ูู ุชู ุชุณููู ุงูุฑุฎุตุฉ ูููุชูุฏูุ')) return;
    try {
      const res = await api.put('/admin/applications/' + id + '/complete');
      if(res.data.status === 'success') location.reload();
    } catch(err) { alert(err.response?.data?.message || 'ุฎุทุฃ'); }
  };

  const downloadSupplyOrder = async (id) => {
    try {
      const res = await api.get('/admin/applications/' + id + '/supply-order');
      if(res.data.status === 'success') {
        console.log('Supply order data:', res.data.data);
        alert('ุจูุงูุงุช ุฃูุฑ ุงูุชูุฑูุฏ ุฌุงูุฒุฉ ููุทุจุงุนุฉ - PDF generation in frontend');
      }
    } catch(err) { alert(err.response?.data?.message || 'ุฎุทุฃ'); }
  };

  const printLicense = async (id) => {
    try {
      const res = await api.get('/admin/applications/' + id + '/license-pdf');
      if(res.data.status === 'success') {
        console.log('License data:', res.data.data);
        alert('ุจูุงูุงุช ุงูุดูุงุฏุฉ ุฌุงูุฒุฉ ููุทุจุงุนุฉ - PDF generation in frontend');
      }
    } catch(err) { alert(err.response?.data?.message || 'ุฎุทุฃ'); }
  };

  document.getElementById('logoutBtnAdmin')?.addEventListener('click', async () => {
    try {
      await api.post('/auth/logout');
      window.location.href = '/login';
    } catch (err) {
      console.error('Logout error:', err);
    }
  });
</script>
