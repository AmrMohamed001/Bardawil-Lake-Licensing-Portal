<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        <%= title %> - منصة تراخيص بحيرة البردويل
    </title>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="icon" type="image/png" href="/imgs/logo.png" />
</head>

<body>
    <%- include('partials/spinner') %> <%- include('partials/navbar') %>

            <div class="admin-users-page">
                <div class="container">
                    <!-- Page Header -->
                    <div class="page-header">
                        <div class="header-content">
                            <h1><i class="fas fa-users-cog"></i> إدارة المستخدمين</h1>
                            <p>عرض وإدارة حسابات المستخدمين في النظام</p>
                        </div>
                        <div class="header-actions">
                            <a href="/admin-dashboard" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-right"></i> العودة للوحة التحكم
                            </a>
                        </div>
                    </div>

                    <!-- Filters Section -->
                    <div class="filters-section">
                        <div class="filters-row">
                            <div class="filter-group">
                                <label><i class="fas fa-search"></i> البحث</label>
                                <input type="text" id="searchInput" class="form-control"
                                    placeholder="ابحث بالاسم أو الرقم القومي..." oninput="filterUsers()" />
                            </div>
                            <div class="filter-group">
                                <label><i class="fas fa-user-tag"></i> الصلاحية</label>
                                <select id="roleFilter" class="form-control" onchange="filterUsers()">
                                    <option value="">الكل</option>
                                    <option value="user">مستخدم عادي</option>
                                    <option value="admin">مسؤول</option>
                                    <option value="super_admin">مسؤول عام</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label><i class="fas fa-toggle-on"></i> الحالة</label>
                                <select id="statusFilter" class="form-control" onchange="filterUsers()">
                                    <option value="">الكل</option>
                                    <option value="active">نشط</option>
                                    <option value="suspended">معلق</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="table-container">
                        <table class="data-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>المستخدم</th>
                                    <th>الرقم القومي</th>
                                    <th>رقم الهاتف</th>
                                    <th>الصلاحية</th>
                                    <th>الحالة</th>
                                    <th>تاريخ التسجيل</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (users && users.length> 0) { %>
                                    <% users.forEach(user=> { %>
                                        <tr data-user-id="<%= user.id %>" data-role="<%= user.role %>"
                                            data-status="<%= user.isActive ? 'active' : 'suspended' %>">
                                            <td>
                                                <div class="user-info">
                                                    <div class="user-avatar">
                                                        <i class="fas fa-user"></i>
                                                    </div>
                                                    <div>
                                                        <strong>
                                                            <%= user.firstNameAr %>
                                                                <%= user.lastNameAr %>
                                                        </strong>
                                                        <small>
                                                            <%= user.email || 'لا يوجد بريد' %>
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td dir="ltr">
                                                <%= user.nationalId %>
                                            </td>
                                            <td dir="ltr">
                                                <%= user.phone %>
                                            </td>
                                            <td>
                                                <span class="role-badge <%= user.role %>">
                                                    <% if (user.role==='user' ) { %>مستخدم
                                                        <% } else if (user.role==='admin' ) { %>مسؤول
                                                            <% } else if (user.role==='super_admin' ) { %>مسؤول عام<% }
                                                                    %>
                                                </span>
                                            </td>
                                            <td>
                                                <span
                                                    class="status-badge <%= user.isActive ? 'active' : 'suspended' %>">
                                                    <%= user.isActive ? 'نشط' : 'معلق' %>
                                                </span>
                                            </td>
                                            <td>
                                                <%= new Date(user.createdAt).toLocaleDateString('ar-EG') %>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn-icon" onclick="viewUser('<%= user.id %>')"
                                                        title="عرض التفاصيل">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <% if (currentUser.role==='super_admin' && user.id
                                                        !==currentUser.id) { %>
                                                        <button class="btn-icon"
                                                            onclick="editUserRole('<%= user.id %>', '<%= user.role %>')"
                                                            title="تعديل الصلاحية">
                                                            <i class="fas fa-user-shield"></i>
                                                        </button>
                                                        <button
                                                            class="btn-icon <%= user.isActive ? 'danger' : 'success' %>"
                                                            onclick="toggleUserStatus('<%= user.id %>', <%= user.isActive %>)"
                                                            title="<%= user.isActive ? 'تعليق الحساب' : 'تفعيل الحساب' %>">
                                                            <i
                                                                class="fas <%= user.isActive ? 'fa-ban' : 'fa-check' %>"></i>
                                                        </button>
                                                        <% } %>
                                                </div>
                                            </td>
                                        </tr>
                                        <% }); %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="7" class="empty-state">
                                                        <i class="fas fa-users"></i>
                                                        <p>لا يوجد مستخدمين</p>
                                                    </td>
                                                </tr>
                                                <% } %>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <% if (pagination && pagination.pages> 1) { %>
                        <div class="pagination">
                            <% for (let i=1; i <=pagination.pages; i++) { %>
                                <a href="?page=<%= i %>" class="page-link <%= pagination.page === i ? 'active' : '' %>">
                                    <%= i %>
                                </a>
                                <% } %>
                        </div>
                        <% } %>
                </div>
            </div>

            <!-- Edit Role Modal -->
            <div class="modal-overlay" id="roleModal" style="display: none;">
                <div class="modal">
                    <div class="modal-header">
                        <h3><i class="fas fa-user-shield"></i> تعديل صلاحية المستخدم</h3>
                        <button class="modal-close" onclick="closeModal('roleModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editUserId" />
                        <div class="form-group">
                            <label>الصلاحية الجديدة</label>
                            <select id="newRole" class="form-control">
                                <option value="user">مستخدم عادي</option>
                                <option value="admin">مسؤول</option>
                                <option value="super_admin">مسؤول عام</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-secondary" onclick="closeModal('roleModal')">إلغاء</button>
                        <button class="btn btn-primary" onclick="saveUserRole()">حفظ</button>
                    </div>
                </div>
            </div>

            <%- include('partials/footer') %>

                <style>
                    .admin-users-page {
                        padding: 2rem 0;
                        min-height: calc(100vh - 200px);
                        background: #f5f7fa;
                    }

                    .page-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 2rem;
                        flex-wrap: wrap;
                        gap: 1rem;
                    }

                    .page-header h1 {
                        font-size: 2rem;
                        font-weight: 700;
                        color: #212121;
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                    }

                    .page-header h1 i {
                        color: #1e3c72;
                    }

                    .page-header p {
                        color: #757575;
                        margin-top: 0.5rem;
                    }

                    /* Filters */
                    .filters-section {
                        background: white;
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1.5rem;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
                    }

                    .filters-row {
                        display: flex;
                        gap: 1.5rem;
                        flex-wrap: wrap;
                    }

                    .filter-group {
                        flex: 1;
                        min-width: 200px;
                    }

                    .filter-group label {
                        display: block;
                        font-size: 0.875rem;
                        font-weight: 600;
                        color: #424242;
                        margin-bottom: 0.5rem;
                    }

                    .filter-group label i {
                        margin-left: 0.25rem;
                        color: #1e3c72;
                    }

                    /* Table */
                    .table-container {
                        background: white;
                        border-radius: 12px;
                        overflow: hidden;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
                    }

                    .data-table {
                        width: 100%;
                        border-collapse: collapse;
                    }

                    .data-table th,
                    .data-table td {
                        padding: 1rem;
                        text-align: right;
                        border-bottom: 1px solid #eee;
                    }

                    .data-table th {
                        background: #f8f9fa;
                        font-weight: 600;
                        color: #424242;
                    }

                    .data-table tbody tr:hover {
                        background: #f8f9fa;
                    }

                    .user-info {
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                    }

                    .user-avatar {
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                    }

                    .user-info small {
                        display: block;
                        color: #9e9e9e;
                        font-size: 0.75rem;
                    }

                    .role-badge {
                        padding: 0.25rem 0.75rem;
                        border-radius: 20px;
                        font-size: 0.75rem;
                        font-weight: 600;
                    }

                    .role-badge.user {
                        background: #e3f2fd;
                        color: #1976d2;
                    }

                    .role-badge.admin {
                        background: #fff3e0;
                        color: #f57c00;
                    }

                    .role-badge.super_admin {
                        background: #fce4ec;
                        color: #c2185b;
                    }

                    .status-badge {
                        padding: 0.25rem 0.5rem;
                        border-radius: 4px;
                        font-size: 0.75rem;
                        font-weight: 600;
                    }

                    .status-badge.active {
                        background: #e8f5e9;
                        color: #2e7d32;
                    }

                    .status-badge.suspended {
                        background: #ffebee;
                        color: #c62828;
                    }

                    .action-buttons {
                        display: flex;
                        gap: 0.5rem;
                    }

                    .btn-icon {
                        width: 32px;
                        height: 32px;
                        border: none;
                        border-radius: 8px;
                        background: #f5f5f5;
                        color: #616161;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }

                    .btn-icon:hover {
                        background: #1e3c72;
                        color: white;
                    }

                    .btn-icon.danger:hover {
                        background: #f44336;
                    }

                    .btn-icon.success:hover {
                        background: #4caf50;
                    }

                    .empty-state {
                        text-align: center;
                        padding: 3rem;
                        color: #9e9e9e;
                    }

                    .empty-state i {
                        font-size: 3rem;
                        margin-bottom: 1rem;
                    }

                    /* Pagination */
                    .pagination {
                        display: flex;
                        justify-content: center;
                        gap: 0.5rem;
                        margin-top: 1.5rem;
                    }

                    .page-link {
                        padding: 0.5rem 1rem;
                        border-radius: 8px;
                        background: white;
                        color: #424242;
                        text-decoration: none;
                        transition: all 0.3s ease;
                    }

                    .page-link:hover,
                    .page-link.active {
                        background: #1e3c72;
                        color: white;
                    }

                    /* Modal */
                    .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                    }

                    .modal {
                        background: white;
                        border-radius: 16px;
                        width: 100%;
                        max-width: 450px;
                        overflow: hidden;
                    }

                    .modal-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1.5rem;
                        border-bottom: 1px solid #eee;
                    }

                    .modal-header h3 {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        font-size: 1.125rem;
                        font-weight: 600;
                    }

                    .modal-header h3 i {
                        color: #1e3c72;
                    }

                    .modal-close {
                        background: none;
                        border: none;
                        font-size: 1.25rem;
                        color: #9e9e9e;
                        cursor: pointer;
                    }

                    .modal-close:hover {
                        color: #f44336;
                    }

                    .modal-body {
                        padding: 1.5rem;
                    }

                    .modal-footer {
                        display: flex;
                        justify-content: flex-end;
                        gap: 1rem;
                        padding: 1.5rem;
                        border-top: 1px solid #eee;
                    }

                    @media (max-width: 768px) {

                        .data-table th:nth-child(3),
                        .data-table td:nth-child(3),
                        .data-table th:nth-child(6),
                        .data-table td:nth-child(6) {
                            display: none;
                        }
                    }
                </style>

                <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
                <script>
                    const currentUser = <% - JSON.stringify({ id: currentUser.id, role: currentUser.role }) %>;

                    function filterUsers() {
                        const search = document.getElementById('searchInput').value.toLowerCase();
                        const role = document.getElementById('roleFilter').value;
                        const status = document.getElementById('statusFilter').value;

                        const rows = document.querySelectorAll('#usersTable tbody tr[data-user-id]');

                        rows.forEach(row => {
                            const text = row.textContent.toLowerCase();
                            const rowRole = row.dataset.role;
                            const rowStatus = row.dataset.status;

                            const matchSearch = !search || text.includes(search);
                            const matchRole = !role || rowRole === role;
                            const matchStatus = !status || rowStatus === status;

                            row.style.display = (matchSearch && matchRole && matchStatus) ? '' : 'none';
                        });
                    }

                    function viewUser(userId) {
                        // Could navigate to user details page
                        window.location.href = `/admin/users/${userId}`;
                    }

                    function editUserRole(userId, currentRole) {
                        document.getElementById('editUserId').value = userId;
                        document.getElementById('newRole').value = currentRole;
                        document.getElementById('roleModal').style.display = 'flex';
                    }

                    function closeModal(modalId) {
                        document.getElementById(modalId).style.display = 'none';
                    }

                    async function saveUserRole() {
                        const userId = document.getElementById('editUserId').value;
                        const newRole = document.getElementById('newRole').value;

                        try {
                            await axios.put(`/api/v1/admin/users/${userId}/role`, { role: newRole });
                            window.location.reload();
                        } catch (err) {
                            alert(err.response?.data?.message || 'حدث خطأ');
                        }
                    }

                    async function toggleUserStatus(userId, isCurrentlyActive) {
                        const action = isCurrentlyActive ? 'تعليق' : 'تفعيل';

                        if (!confirm(`هل أنت متأكد من ${action} هذا الحساب؟`)) {
                            return;
                        }

                        try {
                            await axios.put(`/api/v1/admin/users/${userId}/status`, {
                                isActive: !isCurrentlyActive
                            });
                            window.location.reload();
                        } catch (err) {
                            alert(err.response?.data?.message || 'حدث خطأ');
                        }
                    }
                </script>
</body>

</html>