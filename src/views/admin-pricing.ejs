<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>إعدادات التسعير - منصة تراخيص بحيرة البردويل</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="icon" type="image/png" href="/imgs/logo.png" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
  <style>
    .pricing-page {
      padding: 2rem 0;
      min-height: calc(100vh - 200px);
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .page-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #1e3c72;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .page-header p {
      color: #757575;
      margin: 0.5rem 0 0;
    }

    .btn-add {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.875rem 1.75rem;
      background: linear-gradient(135deg, #00897b 0%, #00695c 100%);
      color: white;
      font-weight: 700;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 105, 92, 0.3);
    }

    .btn-add:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 105, 92, 0.4);
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    @media (max-width: 500px) {
      .cards-grid {
        grid-template-columns: 1fr;
      }
    }

    .price-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .price-card-header {
      padding: 1.25rem 1.5rem;
      font-weight: 700;
      font-size: 1.125rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .price-card-header.blue {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
    }

    .price-card-header.teal {
      background: linear-gradient(135deg, #00897b 0%, #00695c 100%);
      color: white;
    }

    .price-card-body {
      padding: 1.5rem;
    }

    .price-table {
      width: 100%;
      border-collapse: collapse;
    }

    .price-table th {
      padding: 0.75rem 0.5rem;
      text-align: right;
      color: #757575;
      font-weight: 600;
      font-size: 0.875rem;
      border-bottom: 2px solid #e0e0e0;
    }

    .price-table td {
      padding: 1rem 0.5rem;
      text-align: right;
      color: #424242;
      border-bottom: 1px solid #f0f0f0;
    }

    .price-table tr:last-child td {
      border-bottom: none;
    }

    .price-table tr:hover td {
      background: #f8f9fa;
    }

    .price-amount {
      font-weight: 700;
      color: #00897b;
      font-size: 1rem;
    }

    .btn-action {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      margin-left: 0.5rem;
    }

    .btn-edit {
      background: #e3f2fd;
      color: #1976d2;
    }

    .btn-edit:hover {
      background: #bbdefb;
    }

    .btn-delete {
      background: #ffebee;
      color: #c62828;
    }

    .btn-delete:hover {
      background: #ffcdd2;
    }

    .btn-add-row {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .btn-add-row:hover {
      background: #c8e6c9;
    }

    .all-prices-section {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .section-header {
      padding: 1.25rem 1.5rem;
      background: linear-gradient(135deg, #37474f 0%, #263238 100%);
      color: white;
      font-weight: 700;
      font-size: 1.125rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .status-badge {
      padding: 0.375rem 1rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.active {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-badge.inactive {
      background: #f5f5f5;
      color: #9e9e9e;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal h3 {
      font-weight: 700;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      color: #1e3c72;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #424242;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #1e3c72;
      box-shadow: 0 0 0 4px rgba(30, 60, 114, 0.1);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: #f5f7fa;
      border-radius: 10px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .checkbox-group label {
      margin: 0;
      cursor: pointer;
    }

    .modal-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .modal-buttons button {
      flex: 1;
      padding: 1rem;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
    }

    .btn-save {
      background: linear-gradient(135deg, #00897b 0%, #00695c 100%);
      color: white;
      border: none;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 105, 92, 0.3);
    }

    .btn-cancel {
      background: white;
      color: #757575;
      border: 2px solid #e0e0e0;
    }

    .btn-cancel:hover {
      background: #f5f5f5;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #9e9e9e;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <%- include('partials/spinner') %>
    <%- include('partials/navbar') %>

      <div class="pricing-page">
        <div class="container">
          <div class="page-header">
            <div>
              <h1><i class="fas fa-tags"></i> إعدادات التسعير</h1>
              <p>إدارة أسعار التراخيص المختلفة</p>
            </div>
            <button onclick="showAddModal()" class="btn-add">
              <i class="fas fa-plus"></i> إضافة سعر جديد
            </button>
          </div>

          <!-- Price Categories -->
          <div class="cards-grid">
            <!-- Fisherman Licenses -->
            <div class="price-card">
              <div class="price-card-header blue">
                <i class="fas fa-fish"></i> تراخيص الصيادين والتراخيص الأخرى
              </div>
              <div class="price-card-body">
                <table class="price-table">
                  <thead>
                    <tr>
                      <th>الفئة</th>
                      <th>جديد</th>
                      <th>تجديد</th>
                      <th>إجراء</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% const fishermanCategories=['صياد مؤمن عليه', 'صياد غير مؤمن عليه' , 'صياد تحت السن' , 'مندوب'
                      , 'تاجر' , 'عامل تاجر' , 'شيال' ]; fishermanCategories.forEach(cat=> {
                      const newPrice = prices ? prices.find(p => (p.licenseType === 'fisherman' || p.licenseType ===
                      'other') && p.category === cat && !p.isRenewalPrice) : null;
                      const renewPrice = prices ? prices.find(p => (p.licenseType === 'fisherman' || p.licenseType ===
                      'other') && p.category === cat && p.isRenewalPrice) : null;
                      %>
                      <tr>
                        <td><strong>
                            <%= cat %>
                          </strong></td>
                        <td><span class="price-amount">
                            <%= newPrice ? newPrice.price + ' ج.م' : '-' %>
                          </span></td>
                        <td><span class="price-amount">
                            <%= renewPrice ? renewPrice.price + ' ج.م' : '-' %>
                          </span></td>
                        <td>
                          <% if (newPrice) { %>
                            <button onclick="editPrice('<%= newPrice.id %>')" class="btn-action btn-edit"><i
                                class="fas fa-edit"></i></button>
                            <% } else { %>
                              <button onclick="showAddModalFor('fisherman', '<%= cat %>')"
                                class="btn-action btn-add-row"><i class="fas fa-plus"></i></button>
                              <% } %>
                        </td>
                      </tr>
                      <% }) %>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Boat/Vehicle Licenses -->
            <div class="price-card">
              <div class="price-card-header teal">
                <i class="fas fa-ship"></i> تراخيص المراكب والسيارات
              </div>
              <div class="price-card-body">
                <table class="price-table">
                  <thead>
                    <tr>
                      <th>النوع</th>
                      <th>السعر</th>
                      <th>إجراء</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% const vehicleCategories=[ { type: 'boat' , category: 'مركب' , label: 'مركب' }, { type: 'vehicle'
                      , category: 'مركبة' , label: 'سيارة' }, { type: 'vehicle' , category: 'تروسيكل' , label: 'تروسيكل'
                      } ]; vehicleCategories.forEach(cat=> {
                      const price = prices ? prices.find(p => p.licenseType === cat.type && p.category === cat.category)
                      : null;
                      %>
                      <tr>
                        <td><strong>
                            <%= cat.label %>
                          </strong></td>
                        <td><span class="price-amount">
                            <%= price ? price.price + ' ج.م' : '-' %>
                          </span></td>
                        <td>
                          <% if (price) { %>
                            <button onclick="editPrice('<%= price.id %>')" class="btn-action btn-edit"><i
                                class="fas fa-edit"></i></button>
                            <% } else { %>
                              <button onclick="showAddModalFor('<%= cat.type %>', '<%= cat.category %>')"
                                class="btn-action btn-add-row"><i class="fas fa-plus"></i></button>
                              <% } %>
                        </td>
                      </tr>
                      <% }) %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- All Prices Table -->
          <div class="all-prices-section">
            <div class="section-header">
              <i class="fas fa-list"></i> جميع الأسعار المسجلة
            </div>
            <div style="padding: 1.5rem; overflow-x: auto;">
              <% if (prices && prices.length> 0) { %>
                <table class="price-table">
                  <thead>
                    <tr>
                      <th>نوع الترخيص</th>
                      <th>الفئة</th>
                      <th>السعر</th>
                      <th>تجديد؟</th>
                      <th>تاريخ السريان</th>
                      <th>الحالة</th>
                      <th>إجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% prices.forEach(price=> { %>
                      <tr>
                        <td>
                          <% if (price.licenseType==='fisherman' ) { %>صياد
                            <% } else if (price.licenseType==='boat' ) { %>مركب
                              <% } else if (price.licenseType==='vehicle' ) { %>سيارة
                                <% } else if (price.licenseType==='other' ) { %>أخرى
                                  <% } else { %>
                                    <%= price.licenseType %>
                                      <% } %>
                        </td>
                        <td><strong>
                            <%= price.category %>
                          </strong></td>
                        <td><span class="price-amount">
                            <%= price.price %> ج.م
                          </span></td>
                        <td>
                          <%= price.isRenewalPrice ? 'نعم' : 'لا' %>
                        </td>
                        <td>
                          <%= price.effectiveFrom ? new Date(price.effectiveFrom).toLocaleDateString('ar-EG') : '-' %>
                        </td>
                        <td>
                          <span class="status-badge <%= price.isActive ? 'active' : 'inactive' %>">
                            <%= price.isActive ? 'نشط' : 'غير نشط' %>
                          </span>
                        </td>
                        <td>
                          <button onclick="editPrice('<%= price.id %>')" class="btn-action btn-edit"><i
                              class="fas fa-edit"></i></button>
                          <button onclick="deletePrice('<%= price.id %>')" class="btn-action btn-delete"><i
                              class="fas fa-trash"></i></button>
                        </td>
                      </tr>
                      <% }) %>
                  </tbody>
                </table>
                <% } else { %>
                  <div class="empty-state">
                    <i class="fas fa-coins"></i>
                    <p>لا توجد أسعار مسجلة بعد</p>
                  </div>
                  <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Add/Edit Price Modal -->
      <div id="priceModal" class="modal-overlay">
        <div class="modal">
          <h3><i class="fas fa-tag"></i> <span id="modalTitle">إضافة سعر جديد</span></h3>
          <form id="priceForm">
            <input type="hidden" id="priceId">
            <div class="form-group">
              <label>نوع الترخيص</label>
              <select id="licenseType" required>
                <option value="">اختر نوع الترخيص</option>
                <option value="fisherman">صياد</option>
                <option value="boat">مركب</option>
                <option value="vehicle">سيارة</option>
                <option value="other">أخرى</option>
              </select>
            </div>
            <div class="form-group">
              <label>الفئة</label>
              <input type="text" id="category" placeholder="مثال: صياد مؤمن عليه" required>
            </div>
            <div class="form-group">
              <label>السعر (جنيه مصري)</label>
              <input type="number" id="price" step="0.01" min="0" placeholder="0.00" required>
            </div>
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="isRenewalPrice">
                <label for="isRenewalPrice">سعر تجديد</label>
              </div>
            </div>
            <div class="form-group">
              <label>تاريخ بداية السريان</label>
              <input type="date" id="effectiveFrom" required>
            </div>
            <div class="modal-buttons">
              <button type="submit" class="btn-save"><i class="fas fa-check"></i> حفظ</button>
              <button type="button" onclick="hideModal()" class="btn-cancel">إلغاء</button>
            </div>
          </form>
        </div>
      </div>

      <%- include('partials/footer') %>

        <script>
          var api = axios.create({
            baseURL: '/api/v1',
            withCredentials: true
          });

          function showAddModal() {
            document.getElementById('modalTitle').textContent = 'إضافة سعر جديد';
            document.getElementById('priceId').value = '';
            document.getElementById('priceForm').reset();
            document.getElementById('effectiveFrom').value = new Date().toISOString().split('T')[0];
            document.getElementById('priceModal').classList.add('active');
          }

          function showAddModalFor(type, category) {
            showAddModal();
            document.getElementById('licenseType').value = type;
            document.getElementById('category').value = category;
          }

          function hideModal() {
            document.getElementById('priceModal').classList.remove('active');
          }

          function editPrice(id) {
            api.get('/admin/prices/' + id)
              .then(function (res) {
                var price = res.data.data.price;
                document.getElementById('modalTitle').textContent = 'تعديل السعر';
                document.getElementById('priceId').value = price.id;
                document.getElementById('licenseType').value = price.licenseType;
                document.getElementById('category').value = price.category;
                document.getElementById('price').value = price.price;
                document.getElementById('isRenewalPrice').checked = price.isRenewalPrice;
                document.getElementById('effectiveFrom').value = price.effectiveFrom ? price.effectiveFrom.split('T')[0] : '';
                document.getElementById('priceModal').classList.add('active');
              })
              .catch(function (err) {
                alert(err.response?.data?.message || 'خطأ في تحميل البيانات');
              });
          }

          function deletePrice(id) {
            if (!confirm('هل أنت متأكد من حذف هذا السعر؟')) return;
            api.delete('/admin/prices/' + id)
              .then(function () {
                location.reload();
              })
              .catch(function (err) {
                alert(err.response?.data?.message || 'خطأ في الحذف');
              });
          }

          document.getElementById('priceForm').addEventListener('submit', function (e) {
            e.preventDefault();

            var id = document.getElementById('priceId').value;
            var data = {
              licenseType: document.getElementById('licenseType').value,
              category: document.getElementById('category').value,
              price: parseFloat(document.getElementById('price').value),
              isRenewalPrice: document.getElementById('isRenewalPrice').checked,
              effectiveFrom: document.getElementById('effectiveFrom').value
            };

            var request;
            if (id) {
              request = api.put('/admin/prices/' + id, data);
            } else {
              request = api.post('/admin/prices', data);
            }

            request
              .then(function () {
                location.reload();
              })
              .catch(function (err) {
                alert(err.response?.data?.message || 'خطأ في الحفظ');
              });
          });

          // Close modal on backdrop click
          document.getElementById('priceModal').addEventListener('click', function (e) {
            if (e.target === this) {
              hideModal();
            }
          });
        </script>
</body>

</html>