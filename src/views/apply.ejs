<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تقديم طلب جديد - منصة تراخيص بحيرة البردويل</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="icon" type="image/png" href="/imgs/logo.png" />
</head>

<body>
  <%- include('partials/spinner') %> <%- include('partials/navbar') %>

      <div class="apply-page">
        <div class="container">
          <!-- Page Header -->
          <div class="page-header">
            <h1><i class="fas fa-file-alt"></i> تقديم طلب جديد</h1>
            <p>اختر نوع الترخيص واملأ البيانات المطلوبة</p>
          </div>

          <div id="alertContainer"></div>

          <!-- Steps Indicator -->
          <div class="steps-indicator">
            <div class="step active" data-step="1">
              <div class="step-number">1</div>
              <span>نوع الترخيص</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="2">
              <div class="step-number">2</div>
              <span>البيانات الشخصية</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="3">
              <div class="step-number">3</div>
              <span>المستندات</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="4">
              <div class="step-number">4</div>
              <span>المراجعة والإرسال</span>
            </div>
          </div>

          <form id="applicationForm" enctype="multipart/form-data">
            <!-- Step 1: License Type -->
            <div class="form-step active" id="step1">
              <h2>اختر نوع الترخيص</h2>

              <div class="license-type-grid">
                <label class="license-type-card">
                  <input type="radio" name="applicationType" value="fisherman" required />
                  <div class="card-content">
                    <div class="card-icon" style="
                      background: linear-gradient(
                        135deg,
                        #2196f3 0%,
                        #1976d2 100%
                      );
                    ">
                      <i class="fas fa-fish"></i>
                    </div>
                    <h3>ترخيص صياد</h3>
                    <p>الحصول على ترخيص لممارسة الصيد في بحيرة البردويل</p>
                  </div>
                </label>

                <label class="license-type-card">
                  <input type="radio" name="applicationType" value="boat" required />
                  <div class="card-content">
                    <div class="card-icon" style="
                      background: linear-gradient(
                        135deg,
                        #00897b 0%,
                        #00695c 100%
                      );
                    ">
                      <i class="fas fa-ship"></i>
                    </div>
                    <h3>ترخيص مركب</h3>
                    <p>تسجيل مركب جديد أو تجديد ترخيص مركب قائم</p>
                  </div>
                </label>

                <label class="license-type-card">
                  <input type="radio" name="applicationType" value="vehicle" required />
                  <div class="card-content">
                    <div class="card-icon" style="
                      background: linear-gradient(
                        135deg,
                        #ff9800 0%,
                        #f57c00 100%
                      );
                    ">
                      <i class="fas fa-truck"></i>
                    </div>
                    <h3>ترخيص سيارة</h3>
                    <p>ترخيص سيارة أو تروسيكل لنقل الأسماك والمنتجات البحرية</p>
                  </div>
                </label>

                <label class="license-type-card">
                  <input type="radio" name="applicationType" value="other" required />
                  <div class="card-content">
                    <div class="card-icon" style="
                      background: linear-gradient(
                        135deg,
                        #9c27b0 0%,
                        #7b1fa2 100%
                      );
                    ">
                      <i class="fas fa-id-card"></i>
                    </div>
                    <h3>تراخيص أخرى</h3>
                    <p>تاجر، مندوب، شيال، عامل تاجر</p>
                  </div>
                </label>
              </div>

              <!-- Category dropdown -->
              <div class="form-group" id="categoryGroup">
                <label class="form-label">فئة الترخيص</label>
                <select name="licenseCategory" id="licenseCategorySelect" class="form-control" required>
                  <option value="">اختر الفئة</option>
                  <!-- Options will be populated dynamically based on application type -->
                </select>
              </div>

              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="isRenewalCheckbox" onchange="
                  document.getElementById('isRenewalValue').value =
                    this.checked;
                  // Toggle new vs renewal fields for fisherman
                  document
                    .querySelectorAll('.new-license-field')
                    .forEach(el => {
                      el.style.display = this.checked ? 'none' : 'block';
                    });
                  document
                    .querySelectorAll('.renewal-license-field')
                    .forEach(el => {
                      el.style.display = this.checked ? 'block' : 'none';
                    });
                  // Toggle renewal fields for boat
                  document
                    .querySelectorAll('.renewal-only-boat')
                    .forEach(el => {
                      el.style.display = this.checked ? 'flex' : 'none';
                    });
                " />
                  <input type="hidden" name="isRenewal" id="isRenewalValue" value="false" />
                  <span>هذا طلب تجديد ترخيص</span>
                </label>
              </div>

              <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                  التالي <i class="fas fa-arrow-left"></i>
                </button>
              </div>
            </div>

            <!-- Step 2: Personal Information -->
            <div class="form-step" id="step2">
              <h2>البيانات الشخصية</h2>

              <!-- Fisherman Fields -->
              <div class="type-fields fisherman-fields">
                <div class="form-row">
                  <!-- For NEW applications: show national ID (info only, from user profile) -->
                  <div class="form-group new-license-field">
                    <label class="form-label">الرقم القومي</label>
                    <input type="text" name="nationalIdDisplay" class="form-control disabled"
                      value="<%= user.nationalId %>" readonly />
                    <small>الرقم القومي من حسابك</small>
                  </div>

                  <!-- For RENEWAL applications: show previous license number -->
                  <div class="form-group renewal-license-field" style="display: none">
                    <label class="form-label">رقم الرخصة السابقة</label>
                    <input type="text" name="previousLicenseNumber" class="form-control"
                      placeholder="أدخل رقم الرخصة السابقة" />
                  </div>

                  <div class="form-group">
                    <label class="form-label">المرسى التابع له</label>
                    <select name="marina" class="form-control">
                      <option value="">اختر المرسى</option>
                      <option value="اغزوان">اغزوان</option>
                      <option value="النصر">النصر</option>
                      <option value="التلول">التلول</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Boat Fields -->
              <div class="type-fields boat-fields" style="display: none">
                <div class="form-row renewal-only-boat" style="display: none">
                  <div class="form-group">
                    <label class="form-label">رقم الصال</label>
                    <input type="text" name="boatNumber" class="form-control" placeholder="أدخل رقم الصال" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">رقم تسجيل المركب</label>
                    <input type="text" name="boatRegistration" class="form-control" placeholder="رقم التسجيل" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">طول المركب (متر)</label>
                    <input type="number" name="boatLength" class="form-control" placeholder="الطول" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">قوة المحرك (حصان)</label>
                    <input type="number" name="enginePower" class="form-control" placeholder="قوة المحرك" />
                  </div>
                </div>
              </div>

              <!-- Vehicle Fields -->
              <div class="type-fields vehicle-fields" style="display: none">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">رقم لوحة السيارة</label>
                    <input type="text" name="plateNumber" class="form-control" placeholder="رقم اللوحة" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">نوع السيارة</label>
                    <input type="text" name="vehicleType" class="form-control" placeholder="نوع السيارة" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">سنة الصنع</label>
                    <input type="number" name="vehicleYear" class="form-control" placeholder="سنة الصنع" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">سعة الحمولة (كجم)</label>
                    <input type="number" name="capacity" class="form-control" placeholder="السعة" />
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button type="button" class="btn btn-outline-primary" onclick="prevStep(1)">
                  <i class="fas fa-arrow-right"></i> السابق
                </button>
                <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                  التالي <i class="fas fa-arrow-left"></i>
                </button>
              </div>
            </div>

            <!-- Step 3: Documents -->
            <div class="form-step" id="step3">
              <h2>المستندات المطلوبة</h2>

              <!-- Fisherman Documents -->
              <div class="documents-section fisherman-docs">
                <h3><i class="fas fa-fish"></i> مستندات ترخيص الصياد</h3>
                <div class="documents-grid">
                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="criminalRecord" accept="image/*,.pdf"
                        onchange="handleFileUpload(this, 'criminalRecordPreview')" />
                      <div class="upload-content">
                        <i class="fas fa-file-alt"></i>
                        <span>فيش جنائي موجه للجهاز</span>
                        <small>اسحب الملف أو اضغط للرفع</small>
                      </div>
                      <div id="criminalRecordPreview" class="upload-preview"></div>
                    </label>
                  </div>

                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="nationalIdImage" accept="image/*,.pdf"
                        onchange="handleFileUpload(this, 'nationalIdPreview')" />
                      <div class="upload-content">
                        <i class="fas fa-id-card"></i>
                        <span>صورة البطاقة الشخصية سارية</span>
                        <small>اسحب الملف أو اضغط للرفع</small>
                      </div>
                      <div id="nationalIdPreview" class="upload-preview"></div>
                    </label>
                  </div>

                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="militaryStatus" accept="image/*,.pdf"
                        onchange="handleFileUpload(this, 'militaryStatusPreview')" />
                      <div class="upload-content">
                        <i class="fas fa-shield-alt"></i>
                        <span>موقف التجنيد</span>
                        <small>اسحب الملف أو اضغط للرفع</small>
                      </div>
                      <div id="militaryStatusPreview" class="upload-preview"></div>
                    </label>
                  </div>

                  <!-- Insurance document - only shown for insured fisherman -->
                  <div class="document-upload insured-fisherman-doc" style="display: none;">
                    <label class="upload-area">
                      <input type="file" name="insurancePhoto" accept="image/*,.pdf"
                        onchange="handleFileUpload(this, 'insurancePhotoPreview')" />
                      <div class="upload-content">
                        <i class="fas fa-file-medical"></i>
                        <span>صورة التأمين <span class="required-star">*</span></span>
                        <small>مطلوب للصياد المؤمن عليه</small>
                      </div>
                      <div id="insurancePhotoPreview" class="upload-preview"></div>
                    </label>
                  </div>

                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="personalPhoto" accept="image/*"
                        onchange="handleFileUpload(this, 'personalPhotoPreview')" />
                      <div class="upload-content">
                        <i class="fas fa-user"></i>
                        <span>صورة شخصية</span>
                        <small>اسحب الملف أو اضغط للرفع</small>
                      </div>
                      <div id="personalPhotoPreview" class="upload-preview"></div>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Boat Documents -->
              <div class="documents-section boat-docs" style="display: none">
                <h3><i class="fas fa-ship"></i> مستندات ترخيص المركب</h3>

                <!-- Download Form Link -->
                <div class="download-form-section">
                  <div class="info-box">
                    <i class="fas fa-download"></i>
                    <div>
                      <strong>استمارة طلب تجديد ترخيص مركب</strong>
                      <p>قم بتحميل الاستمارة وملئها ثم رفعها مع باقي المستندات</p>
                      <a href="/forms/boat-renewal-form.pdf" download class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download"></i> تحميل الاستمارة
                      </a>
                    </div>
                  </div>
                </div>

                <div class="documents-grid">
                  <div class="document-upload renewal-only-boat" style="display: none">
                    <label class="upload-area">
                      <input type="file" name="previousLicense" accept="image/*,.pdf" onchange="
                        handleFileUpload(this, 'previousLicensePreview')
                      " />
                      <div class="upload-content">
                        <i class="fas fa-file-certificate"></i>
                        <span>رخصة العام السابق</span>
                        <small>اسحب الملف أو اضغط للرفع</small>
                      </div>
                      <div id="previousLicensePreview" class="upload-preview"></div>
                    </label>
                  </div>

                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="ownerPhoto" accept="image/*"
                        onchange="handleFileUpload(this, 'ownerPhotoPreview')" />
                      <div class="upload-content">
                        <i class="fas fa-id-card"></i>
                        <span>صورة بطاقة المالك</span>
                        <small>اسحب الملف أو اضغط للرفع</small>
                      </div>
                      <div id="ownerPhotoPreview" class="upload-preview"></div>
                    </label>
                  </div>

                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="associationLetter" accept="image/*,.pdf" onchange="
                        handleFileUpload(this, 'associationLetterPreview')
                      " />
                      <div class="upload-content">
                        <i class="fas fa-envelope-open-text"></i>
                        <span>خطاب الجمعية</span>
                        <small>يفيد بأن المركب خالي من المديونية</small>
                      </div>
                      <div id="associationLetterPreview" class="upload-preview"></div>
                    </label>
                  </div>

                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="insuranceLetter" accept="image/*,.pdf" onchange="
                        handleFileUpload(this, 'insuranceLetterPreview')
                      " />
                      <div class="upload-content">
                        <i class="fas fa-file-invoice"></i>
                        <span>خطاب التأمينات</span>
                        <small>يفيد بسداد رسوم التأمينات</small>
                      </div>
                      <div id="insuranceLetterPreview" class="upload-preview"></div>
                    </label>
                  </div>

                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="taxReceipt" accept="image/*,.pdf"
                        onchange="handleFileUpload(this, 'taxReceiptPreview')" />
                      <div class="upload-content">
                        <i class="fas fa-receipt"></i>
                        <span>ايصال سداد الضرائب</span>
                        <small>من مأمورية الضرائب</small>
                      </div>
                      <div id="taxReceiptPreview" class="upload-preview"></div>
                    </label>
                  </div>

                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="renewalForm" accept="image/*,.pdf"
                        onchange="handleFileUpload(this, 'renewalFormPreview')" />
                      <div class="upload-content">
                        <i class="fas fa-file-signature"></i>
                        <span>استمارة التجديد</span>
                        <small>استمارة مستقبل مصر بعد ملئها</small>
                      </div>
                      <div id="renewalFormPreview" class="upload-preview"></div>
                    </label>
                  </div>
                </div>

                <div class="form-group renewal-only-boat" style="display: none">
                  <label class="form-label">رقم المركب في الموسم السابق</label>
                  <input type="text" name="previousBoatNumber" class="form-control"
                    placeholder="أدخل رقم المركب في الموسم السابق" />
                </div>
              </div>

              <!-- Vehicle Documents -->
              <div class="documents-section vehicle-docs" style="display: none">
                <h3><i class="fas fa-truck"></i> مستندات ترخيص السيارة</h3>
                <div class="documents-grid">
                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="vehicleLicense" accept="image/*,.pdf"
                        onchange="handleFileUpload(this, 'vehicleLicensePreview')" />
                      <div class="upload-content">
                        <i class="fas fa-car"></i>
                        <span>رخصة السيارة</span>
                        <small>اسحب الملف أو اضغط للرفع</small>
                      </div>
                      <div id="vehicleLicensePreview" class="upload-preview"></div>
                    </label>
                  </div>

                  <div class="document-upload">
                    <label class="upload-area">
                      <input type="file" name="driverLicense" accept="image/*,.pdf"
                        onchange="handleFileUpload(this, 'driverLicensePreview')" />
                      <div class="upload-content">
                        <i class="fas fa-id-card"></i>
                        <span>رخصة القيادة</span>
                        <small>اسحب الملف أو اضغط للرفع</small>
                      </div>
                      <div id="driverLicensePreview" class="upload-preview"></div>
                    </label>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button type="button" class="btn btn-outline-primary" onclick="prevStep(2)">
                  <i class="fas fa-arrow-right"></i> السابق
                </button>
                <button type="button" class="btn btn-primary" onclick="nextStep(4)">
                  التالي <i class="fas fa-arrow-left"></i>
                </button>
              </div>
            </div>

            <!-- Step 4: Review and Submit -->
            <div class="form-step" id="step4">
              <h2>مراجعة البيانات</h2>

              <div class="review-card card">
                <h3>ملخص الطلب</h3>
                <div id="reviewContent">
                  <!-- Will be populated dynamically -->
                </div>
              </div>

              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" name="agreeTerms" required />
                  <span>أقر بأن جميع البيانات المدخلة صحيحة وأتحمل المسؤولية
                    الكاملة</span>
                </label>
              </div>

              <div class="form-actions">
                <button type="button" class="btn btn-outline-primary" onclick="prevStep(3)">
                  <i class="fas fa-arrow-right"></i> السابق
                </button>
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                  <span class="btn-text"><i class="fas fa-paper-plane"></i> إرسال الطلب</span>
                  <span class="btn-loading hidden">
                    <i class="fas fa-spinner fa-spin"></i> جاري الإرسال...
                  </span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <%- include('partials/footer') %>

        <style>
          .apply-page {
            padding: 2rem 0;
            min-height: calc(100vh - 200px);
            background: #fafafa;
          }

          .page-header {
            text-align: center;
            margin-bottom: 2rem;
          }

          .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #212121;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
          }

          .page-header h1 i {
            color: #1e3c72;
          }

          .page-header p {
            color: #757575;
          }

          /* Steps Indicator */
          .steps-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 3rem;
            padding: 0 2rem;
          }

          .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #9e9e9e;
          }

          .step.active {
            color: #1e3c72;
          }

          .step.completed {
            color: #4caf50;
          }

          .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
          }

          .step.active .step-number {
            background: linear-gradient(135deg, #1e3c72 0%, #00897b 100%);
            color: white;
          }

          .step.completed .step-number {
            background: #4caf50;
            color: white;
          }

          .step span {
            font-weight: 600;
            font-size: 0.9375rem;
          }

          .step-line {
            width: 60px;
            height: 2px;
            background: #e0e0e0;
            margin: 0 0.75rem;
          }

          /* Form Steps */
          .form-step {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            max-width: 800px;
            margin: 0 auto;
          }

          .form-step.active {
            display: block;
          }

          .form-step h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #212121;
            margin-bottom: 2rem;
            text-align: center;
          }

          /* License Type Cards */
          .license-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
          }

          .license-type-card {
            cursor: pointer;
          }

          .license-type-card input {
            display: none;
          }

          .license-type-card .card-content {
            text-align: center;
            padding: 2rem 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 1rem;
            transition: all 0.3s;
          }

          .license-type-card:hover .card-content {
            border-color: #1e3c72;
            box-shadow: 0 4px 20px rgba(30, 60, 114, 0.15);
          }

          .license-type-card input:checked+.card-content {
            border-color: #1e3c72;
            background: linear-gradient(135deg,
                rgba(30, 60, 114, 0.05) 0%,
                rgba(0, 137, 123, 0.05) 100%);
            box-shadow: 0 4px 20px rgba(30, 60, 114, 0.15);
          }

          .card-icon {
            width: 70px;
            height: 70px;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
            color: white;
          }

          .license-type-card h3 {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #212121;
          }

          .license-type-card p {
            color: #757575;
            font-size: 0.875rem;
            line-height: 1.5;
          }

          /* Form Row */
          .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
          }

          .form-group {
            margin-bottom: 1.5rem;
          }

          .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #424242;
          }

          .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.2s;
          }

          .form-control:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
          }

          .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            color: #424242;
          }

          .checkbox-label input {
            width: 20px;
            height: 20px;
            accent-color: #1e3c72;
          }

          /* Documents */
          .documents-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
          }

          .upload-area {
            display: block;
            border: 2px dashed #e0e0e0;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
          }

          .upload-area:hover {
            border-color: #1e3c72;
            background: rgba(30, 60, 114, 0.02);
          }

          .upload-area.has-file {
            border-color: #4caf50;
            border-style: solid;
          }

          .upload-area input {
            display: none;
          }

          .upload-content i {
            font-size: 2.5rem;
            color: #9e9e9e;
            margin-bottom: 0.75rem;
            display: block;
          }

          .upload-content span {
            display: block;
            font-weight: 600;
            color: #424242;
            margin-bottom: 0.25rem;
          }

          .upload-content small {
            color: #9e9e9e;
          }

          .upload-preview {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: none;
          }

          .upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
          }

          .upload-preview.has-file {
            display: flex;
            align-items: center;
            justify-content: center;
          }

          /* Document Sections */
          .documents-section {
            margin-bottom: 2rem;
          }

          .documents-section h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
          }

          .download-form-section {
            margin-bottom: 1.5rem;
          }

          .info-box {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.25rem;
            background: linear-gradient(135deg,
                rgba(30, 60, 114, 0.05) 0%,
                rgba(0, 137, 123, 0.05) 100%);
            border: 1px solid rgba(30, 60, 114, 0.2);
            border-radius: 0.75rem;
          }

          .info-box>i {
            font-size: 1.5rem;
            color: #1e3c72;
            margin-top: 0.25rem;
          }

          .info-box strong {
            display: block;
            color: #212121;
            margin-bottom: 0.25rem;
          }

          .info-box p {
            color: #616161;
            font-size: 0.9375rem;
            margin-bottom: 0.75rem;
          }

          .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
          }

          /* Review Card */
          .review-card {
            padding: 2rem;
            margin-bottom: 2rem;
          }

          .review-card h3 {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: #212121;
          }

          #reviewContent {
            display: grid;
            gap: 1rem;
          }

          .review-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
          }

          .review-row:last-child {
            border-bottom: none;
          }

          .review-label {
            color: #757575;
            font-weight: 500;
          }

          .review-value {
            font-weight: 600;
            color: #212121;
          }

          /* Form Actions */
          .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #eee;
          }

          .btn-outline-primary {
            border: 2px solid #1e3c72;
            color: #1e3c72;
            background: transparent;
          }

          .btn-outline-primary:hover {
            background: #1e3c72;
            color: white;
          }

          .hidden {
            display: none !important;
          }

          @media (max-width: 1024px) {
            .steps-indicator {
              flex-wrap: wrap;
              gap: 1rem;
            }

            .step span {
              display: none;
            }

            .step-line {
              width: 30px;
            }
          }

          @media (max-width: 768px) {
            .license-type-grid {
              grid-template-columns: 1fr;
            }

            .form-row {
              grid-template-columns: 1fr;
            }

            .documents-grid {
              grid-template-columns: 1fr;
            }

            .form-actions {
              flex-direction: column-reverse;
              gap: 1rem;
            }

            .form-actions .btn {
              width: 100%;
            }
          }
        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
        <script src="/js/main.js"></script>
        <script>
          let currentStep = 1;

          // License category options based on application type
          // Updated per user requirements:
          // - Fisherman: صياد مؤمن عليه، صياد غير مؤمن عليه، صياد تحت السن only
          // - Other: مندوب، تاجر، عامل تاجر، شيال (separate category)
          // - Boat: Always مركب (no dropdown needed)
          // - Vehicle: مركبة، تروسيكل
          const licenseCategoryOptions = {
            fisherman: [
              { value: 'صياد مؤمن عليه', label: 'صياد مؤمن عليه', insured: true },
              { value: 'صياد غير مؤمن عليه', label: 'صياد غير مؤمن عليه', insured: false },
              { value: 'صياد تحت السن', label: 'صياد تحت السن', insured: false },
            ],
            other: [
              { value: 'مندوب', label: 'مندوب' },
              { value: 'تاجر', label: 'تاجر' },
              { value: 'عامل تاجر', label: 'عامل تاجر' },
              { value: 'شيال', label: 'شيال' },
            ],
            boat: [
              { value: 'مركب', label: 'مركب' },
            ],
            vehicle: [
              { value: 'مركبة', label: 'مركبة' },
              { value: 'تروسيكل', label: 'تروسيكل' },
            ],
          };

          // Track if current fisherman category requires insurance
          let currentCategoryRequiresInsurance = false;

          // Function to update license category dropdown
          function updateLicenseCategoryOptions(applicationType) {
            const select = document.getElementById('licenseCategorySelect');
            const categoryGroup = document.getElementById('categoryGroup');

            select.innerHTML = '<option value="">اختر الفئة</option>';

            // For boat, hide category dropdown and auto-select مركب
            if (applicationType === 'boat') {
              categoryGroup.style.display = 'none';
              select.innerHTML = '<option value="مركب" selected>مركب</option>';
              return;
            }

            // Show category dropdown for other types
            categoryGroup.style.display = 'block';

            const options = licenseCategoryOptions[applicationType] || [];
            options.forEach(opt => {
              const option = document.createElement('option');
              option.value = opt.value;
              option.textContent = opt.label;
              select.appendChild(option);
            });
          }

          // Handle fisherman category change to show/hide insurance document
          document.getElementById('licenseCategorySelect').addEventListener('change', function () {
            const selectedValue = this.value;
            const applicationType = document.querySelector('input[name="applicationType"]:checked')?.value;

            // Only for fisherman type
            if (applicationType === 'fisherman') {
              const insuranceDoc = document.querySelector('.insured-fisherman-doc');
              const options = licenseCategoryOptions.fisherman;
              const selectedOption = options.find(opt => opt.value === selectedValue);

              if (selectedOption && selectedOption.insured) {
                insuranceDoc.style.display = 'block';
                currentCategoryRequiresInsurance = true;
              } else {
                insuranceDoc.style.display = 'none';
                currentCategoryRequiresInsurance = false;
              }
            }
          });

          // Handle license type selection to show relevant fields
          document
            .querySelectorAll('input[name="applicationType"]')
            .forEach(radio => {
              radio.addEventListener('change', function () {
                // Update license category options
                updateLicenseCategoryOptions(this.value);

                // Hide all type-specific fields
                document
                  .querySelectorAll('.type-fields')
                  .forEach(el => (el.style.display = 'none'));
                document
                  .querySelectorAll('.boat-only, .vehicle-only')
                  .forEach(el => (el.style.display = 'none'));

                // Hide all document sections
                document
                  .querySelectorAll('.documents-section')
                  .forEach(el => (el.style.display = 'none'));

                // Show relevant fields and documents
                if (this.value === 'fisherman') {
                  document.querySelector('.fisherman-fields').style.display =
                    'block';
                  document.querySelector('.fisherman-docs').style.display = 'block';
                } else if (this.value === 'boat') {
                  document.querySelector('.boat-fields').style.display = 'block';
                  document.querySelector('.boat-docs').style.display = 'block';
                  document
                    .querySelectorAll('.boat-only')
                    .forEach(el => (el.style.display = 'block'));
                } else if (this.value === 'vehicle') {
                  document.querySelector('.vehicle-fields').style.display = 'block';
                  document.querySelector('.vehicle-docs').style.display = 'block';
                  document
                    .querySelectorAll('.vehicle-only')
                    .forEach(el => (el.style.display = 'block'));
                } else if (this.value === 'other') {
                  // For 'other' types (تاجر، مندوب، شيال، عامل تاجر) use fisherman forms/docs
                  document.querySelector('.fisherman-fields').style.display = 'block';
                  document.querySelector('.fisherman-docs').style.display = 'block';
                }
              });

              // Trigger if already checked (on page load/refresh)
              if (radio.checked) {
                radio.dispatchEvent(new Event('change'));
              }
            });

          function updateSteps() {
            document.querySelectorAll('.step').forEach((step, index) => {
              const stepNum = index + 1;
              step.classList.remove('active', 'completed');

              if (stepNum < currentStep) {
                step.classList.add('completed');
              } else if (stepNum === currentStep) {
                step.classList.add('active');
              }
            });
          }

          function nextStep(step) {
            // Validate current step
            const currentStepEl = document.getElementById(`step${currentStep}`);
            const inputs = currentStepEl.querySelectorAll('[required]');
            let valid = true;

            inputs.forEach(input => {
              if (!input.value && !input.checked) {
                valid = false;
                input.style.borderColor = '#F44336';
              } else {
                input.style.borderColor = '';
              }
            });

            if (!valid) {
              showFormAlert('الرجاء ملء جميع الحقول المطلوبة');
              return;
            }

            // If moving to review step, populate review content
            if (step === 4) {
              populateReview();
            }

            currentStep = step;
            document
              .querySelectorAll('.form-step')
              .forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            updateSteps();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }

          function prevStep(step) {
            currentStep = step;
            document
              .querySelectorAll('.form-step')
              .forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            updateSteps();
          }

          function handleFileUpload(input, previewId) {
            const preview = document.getElementById(previewId);
            const uploadArea = input.closest('.upload-area');

            if (input.files && input.files[0]) {
              const reader = new FileReader();
              reader.onload = function (e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                preview.classList.add('has-file');
                uploadArea.classList.add('has-file');
              };
              reader.readAsDataURL(input.files[0]);
            }
          }

          function populateReview() {
            const form = document.getElementById('applicationForm');
            const formData = new FormData(form);

            const typeLabels = {
              fisherman: 'ترخيص صياد',
              boat: 'ترخيص مركب',
              vehicle: 'ترخيص سيارة',
            };

            let html = `
    <div class="review-row">
      <span class="review-label">نوع الترخيص</span>
      <span class="review-value">${typeLabels[formData.get('applicationType')] || '-'}</span>
    </div>
    <div class="review-row">
      <span class="review-label">فئة الترخيص</span>
      <span class="review-value">${formData.get('licenseCategory') || '-'}</span>
    </div>
    <div class="review-row">
      <span class="review-label">نوع الطلب</span>
      <span class="review-value">${formData.get('isRenewal') === 'true' ? 'تجديد' : 'جديد'}</span>
    </div>
  `;

            document.getElementById('reviewContent').innerHTML = html;
          }

          function showFormAlert(message, type = 'danger') {
            const container = document.getElementById('alertContainer');
            const icons = {
              success: 'check-circle',
              danger: 'exclamation-circle',
              warning: 'exclamation-triangle',
            };

            container.innerHTML = `
    <div class="alert alert-${type}">
      <i class="fas fa-${icons[type]} alert-icon"></i>
      <div class="alert-content"><p>${message}</p></div>
      <button class="alert-close" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;
          }

          document
            .getElementById('applicationForm')
            .addEventListener('submit', async function (e) {
              e.preventDefault();

              // Validate required fields before submission
              const applicationType = document.querySelector(
                'input[name="applicationType"]:checked'
              );
              const licenseCategory = document.getElementById(
                'licenseCategorySelect'
              ).value;

              if (!applicationType) {
                showFormAlert('يجب اختيار نوع الترخيص');
                return;
              }

              if (!licenseCategory) {
                showFormAlert('يجب اختيار فئة الترخيص');
                return;
              }

              // Validate personal info based on application type
              if (applicationType.value === 'fisherman') {
                const marina = document.querySelector('select[name="marina"]');
                const isRenewal =
                  document.getElementById('isRenewalCheckbox').checked;

                // For renewals, require previous license number
                if (isRenewal) {
                  const prevLicense = document.querySelector(
                    'input[name="previousLicenseNumber"]'
                  );
                  if (!prevLicense || !prevLicense.value.trim()) {
                    showFormAlert('يجب إدخال رقم الرخصة السابقة');
                    return;
                  }
                }

                if (!marina || !marina.value) {
                  showFormAlert('يجب اختيار المرسى');
                  return;
                }
              }

              // Validate boat fields
              if (applicationType.value === 'boat') {
                // Only validate if renewal (check checkbox)
                const isRenewal =
                  document.getElementById('isRenewalCheckbox').checked;
                if (isRenewal) {
                  const boatNumber = document.querySelector(
                    'input[name="boatNumber"]'
                  );
                  if (!boatNumber || !boatNumber.value.trim()) {
                    showFormAlert('يجب إدخال رقم الصال');
                    return;
                  }
                }
              }

              // Validate vehicle fields
              if (applicationType.value === 'vehicle') {
                const plateNumber = document.querySelector(
                  'input[name="plateNumber"]'
                );
                if (!plateNumber || !plateNumber.value.trim()) {
                  showFormAlert('يجب إدخال رقم لوحة السيارة');
                  return;
                }
              }

              const submitBtn = document.getElementById('submitBtn');
              const btnText = submitBtn.querySelector('.btn-text');
              const btnLoading = submitBtn.querySelector('.btn-loading');

              btnText.classList.add('hidden');
              btnLoading.classList.remove('hidden');
              submitBtn.disabled = true;

              const formData = new FormData(this);

              try {
                // Use api client from main.js
                const res = await api.post('/applications', formData, {
                  headers: { 'Content-Type': 'multipart/form-data' },
                });

                if (res.data.status === 'success') {
                  showFormAlert('تم إرسال الطلب بنجاح! جاري التحويل...', 'success');
                  setTimeout(() => {
                    window.location.href = '/dashboard';
                  }, 2000);
                }
              } catch (err) {
                showFormAlert(
                  err.response?.data?.message || 'حدث خطأ أثناء إرسال الطلب'
                );
              } finally {
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                submitBtn.disabled = false;
              }
            });
        </script>
</body>

</html>