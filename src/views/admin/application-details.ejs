<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #<%= application.applicationNumber %> - Ù…Ù†ØµØ© ØªØ±Ø§Ø®ÙŠØµ Ø¨Ø­ÙŠØ±Ø© Ø§Ù„Ø¨Ø±Ø¯ÙˆÙŠÙ„</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="icon" type="image/png" href="/imgs/logo.png" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
  <style>
    .admin-detail-page {
      padding: 2rem 0;
      min-height: calc(100vh - 200px);
      background: #f5f7fa;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
    }

    @media (max-width: 768px) {
      .detail-grid {
        grid-template-columns: 1fr;
      }
    }

    .detail-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    .detail-card-header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .detail-card-header h2 {
      font-size: 1.125rem;
      font-weight: 600;
    }

    .detail-card-body {
      padding: 1.5rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .info-item label {
      display: block;
      color: #757575;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }

    .info-item p {
      font-weight: 600;
      color: #212121;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.pending {
      background: #fff3e0;
      color: #f57c00;
    }

    .status-badge.review {
      background: #e3f2fd;
      color: #1976d2;
    }

    .status-badge.payment {
      background: #fce4ec;
      color: #c2185b;
    }

    .status-badge.verified {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-badge.ready {
      background: #e0f2f1;
      color: #00796b;
    }

    .status-badge.completed {
      background: #c8e6c9;
      color: #1b5e20;
    }

    .status-badge.rejected {
      background: #ffebee;
      color: #c62828;
    }

    .docs-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .doc-item {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 0.5rem;
    }

    .doc-item img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
    }

    .doc-item p {
      font-size: 0.75rem;
      color: #757575;
      margin-top: 0.5rem;
      font-weight: 600;
    }

    .history-item {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .history-dot {
      width: 10px;
      height: 10px;
      background: #1e3c72;
      border-radius: 50%;
      margin-top: 5px;
    }

    .action-btn {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      font-weight: 600;
      margin-bottom: 0.5rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn.primary {
      background: #1e3c72;
      color: white;
    }

    .action-btn.success {
      background: #4caf50;
      color: white;
    }

    .action-btn.danger {
      background: #f44336;
      color: white;
    }

    .action-btn.outline {
      background: white;
      border: 1px solid #e0e0e0;
      color: #424242;
    }

    .action-btn:hover {
      opacity: 0.9;
    }

    .applicant-card {
      text-align: center;
    }

    .applicant-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #e0e0e0;
      margin: 0 auto 1rem;
      overflow: hidden;
    }

    .applicant-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
    }

    .notice-box {
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .notice-box.warning {
      background: #fff8e1;
      color: #f57c00;
    }

    .notice-box.success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .notice-box.error {
      background: #ffebee;
      color: #c62828;
    }
  </style>
</head>

<body>
  <%- include('../partials/spinner') %>
    <%- include('../partials/navbar') %>

      <div class="admin-detail-page">
        <div class="container">
          <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 0.5rem; color: #757575; font-size: 0.875rem;">
              <a href="/admin-dashboard" style="color: #1e3c72;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
              <span>/</span>
              <span style="color: #212121; font-weight: 600;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #<%= application.applicationNumber %></span>
            </div>
            <a href="/admin/applications" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-right"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            </a>
          </div>

          <div class="detail-grid">
            <div>
              <div class="detail-card">
                <div class="detail-card-header">
                  <h2><i class="fas fa-file-alt"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h2>
                  <%- include('../partials/status-badge', { status: application.status, statusInfo: application.statusInfo
                    }) %>
                </div>
                <div class="detail-card-body">
                  <div class="info-grid">
                    <div class="info-item"><label>Ù†ÙˆØ¹ Ø§Ù„ØªØ±Ø®ÙŠØµ</label>
                      <p>
                        <%= application.applicationType==='fisherman' ? 'ØµÙŠØ§Ø¯' : application.applicationType==='boat'
                          ? 'Ù…Ø±ÙƒØ¨' : application.applicationType==='vehicle' ? 'Ø³ÙŠØ§Ø±Ø©' :
                          application.applicationType==='other' ? 'ØªØ±Ø§Ø®ÙŠØµ Ø£Ø®Ø±Ù‰' : application.applicationType %>
                      </p>
                    </div>
                    <div class="info-item"><label>Ø§Ù„ÙØ¦Ø©</label>
                      <p>
                        <%= application.licenseCategory %>
                      </p>
                    </div>
                    <div class="info-item"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</label>
                      <p>
                        <%= new Date(application.createdAt).toLocaleDateString('ar-EG') %>
                      </p>
                    </div>
                    <div class="info-item"><label>Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</label>
                      <p>
                        <%= application.supplyOrderId || '-' %>
                      </p>
                    </div>
                    <% if (application.paymentAmount) { %>
                      <div class="info-item"><label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
                        <p style="color: #00796b; font-size: 1.25rem;">
                          <%= application.paymentAmount %> Ø¬.Ù…
                        </p>
                      </div>
                      <% } %>
                        <% if (application.rejectionReason) { %>
                          <div class="info-item" style="grid-column: span 2;"><label>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</label>
                            <p style="color: #c62828;">
                              <%= application.rejectionReason %>
                            </p>
                          </div>
                          <% } %>
                  </div>
                </div>
              </div>

              <div class="detail-card">
                <div class="detail-card-header" style="background: #424242;">
                  <h2><i class="fas fa-paperclip"></i> Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h2>
                </div>
                <div class="detail-card-body">
                  <% if (application.documents && application.documents.length> 0) { %>
                    <div class="docs-grid">
                      <% application.documents.forEach(doc=> {
                        const imgName = doc.fileName || (doc.filePath ? doc.filePath.split('/').pop() : '');
                        %>
                        <div class="doc-item">
                          <% if (imgName && imgName.match(/\.(jpg|jpeg|png|gif)$/i)) { %>
                            <img src="/uploads/<%= imgName %>" onclick="window.open(this.src)"
                              alt="<%= doc.documentType %>">
                            <% } else if (imgName) { %>
                              <a href="/uploads/<%= imgName %>" target="_blank"
                                style="display: flex; align-items: center; justify-content: center; height: 150px; background: #f5f5f5; border-radius: 4px;">
                                <i class="fas fa-file" style="font-size: 3rem; color: #9e9e9e;"></i>
                              </a>
                              <% } %>
                                <p>
                                  <%= doc.documentType %>
                                </p>
                        </div>
                        <% }) %>
                    </div>
                    <% } else { %>
                      <p style="text-align: center; color: #9e9e9e; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª</p>
                      <% } %>
                </div>
              </div>

              <div class="detail-card">
                <div class="detail-card-header" style="background: #616161;">
                  <h2><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø©</h2>
                </div>
                <div class="detail-card-body">
                  <% if (application.statusHistory && application.statusHistory.length> 0) { %>
                    <% application.statusHistory.forEach(history=> { %>
                      <div class="history-item">
                        <div class="history-dot"></div>
                        <div>
                          <p style="font-weight: 600;">
                            <%= history.oldStatus || 'Ø¬Ø¯ÙŠØ¯' %> â†’ <%= history.newStatus %>
                          </p>
                          <% if (history.notes) { %>
                            <p style="color: #757575; font-size: 0.875rem;">
                              <%= history.notes %>
                            </p>
                            <% } %>
                              <p style="color: #9e9e9e; font-size: 0.75rem; margin-top: 0.25rem;">
                                <%= new Date(history.changedAt).toLocaleString('ar-EG') %>
                                  <% if (history.changedByUser) { %> - Ø¨ÙˆØ§Ø³Ø·Ø© <%= history.changedByUser.firstNameAr %>
                                      <%= history.changedByUser.lastNameAr %>
                                        <% } %>
                              </p>
                        </div>
                      </div>
                      <% }) %>
                        <% } else { %>
                          <p style="text-align: center; color: #9e9e9e;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø§Ù„Ø©</p>
                          <% } %>
                </div>
              </div>
            </div>

            <div>
              <!-- Applicant Information -->
              <div class="detail-card applicant-card">
                <div class="detail-card-header" style="background: linear-gradient(135deg, #00897b 0%, #00695c 100%);">
                  <h2><i class="fas fa-user"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨</h2>
                </div>
                <div class="detail-card-body">
                  <div class="applicant-avatar"><img
                      src="<%= application.applicant?.profilePicture || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(application.applicant?.firstNameAr || 'User') + '&background=1e3c72&color=fff' %>">
                  </div>
                  <h3 style="font-weight: 700; margin-bottom: 0.5rem; font-size: 1.25rem;">
                    <%= application.applicant?.firstNameAr %>
                      <%= application.applicant?.lastNameAr %>
                  </h3>
                  <div style="display: grid; gap: 0.75rem; margin-top: 1rem; text-align: right;">
                    <div
                      style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 8px;">
                      <i class="fas fa-id-card" style="color: #1e3c72;"></i>
                      <span style="color: #757575; font-size: 0.875rem;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</span>
                      <strong>
                        <%= application.applicant?.nationalId %>
                      </strong>
                    </div>
                    <div
                      style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 8px;">
                      <i class="fas fa-phone" style="color: #00897b;"></i>
                      <span style="color: #757575; font-size: 0.875rem;">Ø§Ù„Ù‡Ø§ØªÙ:</span>
                      <strong>
                        <%= application.applicant?.phone %>
                      </strong>
                    </div>
                    <% if (application.applicant?.email) { %>
                      <div
                        style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 8px;">
                        <i class="fas fa-envelope" style="color: #e53935;"></i>
                        <span style="color: #757575; font-size: 0.875rem;">Ø§Ù„Ø¨Ø±ÙŠØ¯:</span>
                        <strong>
                          <%= application.applicant?.email %>
                        </strong>
                      </div>
                      <% } %>
                        <% if (application.applicant?.address) { %>
                          <div
                            style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 8px;">
                            <i class="fas fa-map-marker-alt" style="color: #ff9800;"></i>
                            <span style="color: #757575; font-size: 0.875rem;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span>
                            <strong>
                              <%= application.applicant?.address %>
                            </strong>
                          </div>
                          <% } %>
                  </div>
                </div>
              </div>

              <!-- Application Data Card -->
              <% const appData=application.data ? (typeof application.data==='string' ? JSON.parse(application.data) :
                application.data) : {}; const hasData=Object.keys(appData).length> 0;
                %>
                <% if (hasData) { %>
                  <div class="detail-card" style="margin-top: 1rem;">
                    <div class="detail-card-header" style="background: #37474f;">
                      <h2><i class="fas fa-clipboard-list"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø®ÙŠØµ</h2>
                    </div>
                    <div class="detail-card-body">
                      <div class="info-grid">
                        <% if (appData.marina) { %>
                          <div class="info-item"><label>Ø§Ù„Ù…Ø±Ø³Ù‰</label>
                            <p>
                              <%= appData.marina %>
                            </p>
                          </div>
                          <% } %>
                            <% if (appData.unionCardNumber) { %>
                              <div class="info-item"><label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†Ù‚Ø§Ø¨ÙŠØ©</label>
                                <p>
                                  <%= appData.unionCardNumber %>
                                </p>
                              </div>
                              <% } %>
                                <% if (appData.previousLicenseNumber) { %>
                                  <div class="info-item"><label>Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</label>
                                    <p>
                                      <%= appData.previousLicenseNumber %>
                                    </p>
                                  </div>
                                  <% } %>
                                    <% if (appData.boatNumber) { %>
                                      <div class="info-item"><label>Ø±Ù‚Ù… Ø§Ù„ØµØ§Ù„</label>
                                        <p>
                                          <%= appData.boatNumber %>
                                        </p>
                                      </div>
                                      <% } %>
                                        <% if (appData.boatRegistration) { %>
                                          <div class="info-item"><label>Ø±Ù‚Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨</label>
                                            <p>
                                              <%= appData.boatRegistration %>
                                            </p>
                                          </div>
                                          <% } %>
                                            <% if (appData.boatLength) { %>
                                              <div class="info-item"><label>Ø·ÙˆÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨</label>
                                                <p>
                                                  <%= appData.boatLength %> Ù…ØªØ±
                                                </p>
                                              </div>
                                              <% } %>
                                                <% if (appData.enginePower) { %>
                                                  <div class="info-item"><label>Ù‚ÙˆØ© Ø§Ù„Ù…Ø­Ø±Ùƒ</label>
                                                    <p>
                                                      <%= appData.enginePower %> Ø­ØµØ§Ù†
                                                    </p>
                                                  </div>
                                                  <% } %>
                                                    <% if (appData.plateNumber) { %>
                                                      <div class="info-item"><label>Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                                                        <p>
                                                          <%= appData.plateNumber %>
                                                        </p>
                                                      </div>
                                                      <% } %>
                                                        <% if (appData.vehicleType) { %>
                                                          <div class="info-item"><label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                                                            <p>
                                                              <%= appData.vehicleType %>
                                                            </p>
                                                          </div>
                                                          <% } %>
                                                            <% if (appData.vehicleYear) { %>
                                                              <div class="info-item"><label>Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹</label>
                                                                <p>
                                                                  <%= appData.vehicleYear %>
                                                                </p>
                                                              </div>
                                                              <% } %>
                                                                <% if (appData.capacity) { %>
                                                                  <div class="info-item"><label>Ø§Ù„Ø³Ø¹Ø©</label>
                                                                    <p>
                                                                      <%= appData.capacity %>
                                                                    </p>
                                                                  </div>
                                                                  <% } %>
                                                                    <% if (appData.motorNumber) { %>
                                                                      <div class="info-item"><label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØªÙˆØ±</label>
                                                                        <p>
                                                                          <%= appData.motorNumber %>
                                                                        </p>
                                                                      </div>
                                                                      <% } %>
                                                                        <% if (appData.chassisNumber) { %>
                                                                          <div class="info-item"><label>Ø±Ù‚Ù…
                                                                              Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡</label>
                                                                            <p>
                                                                              <%= appData.chassisNumber %>
                                                                            </p>
                                                                          </div>
                                                                          <% } %>
                                                                            <% if (appData.ownerName) { %>
                                                                              <div class="info-item"><label>Ø§Ø³Ù…
                                                                                  Ø§Ù„Ù…Ø§Ù„Ùƒ</label>
                                                                                <p>
                                                                                  <%= appData.ownerName %>
                                                                                </p>
                                                                              </div>
                                                                              <% } %>
                                                                                <% if (appData.ownerNationalId) { %>
                                                                                  <div class="info-item"><label>Ø§Ù„Ø±Ù‚Ù…
                                                                                      Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù„Ù„Ù…Ø§Ù„Ùƒ</label>
                                                                                    <p>
                                                                                      <%= appData.ownerNationalId %>
                                                                                    </p>
                                                                                  </div>
                                                                                  <% } %>
                      </div>
                    </div>
                  </div>
                  <% } %>

                    <div class="detail-card">
                      <div class="detail-card-body">
                        <h3 style="font-weight: 600; margin-bottom: 1rem; font-size: 0.875rem;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
                        <% if (application.status==='received' ) { %><button
                            onclick="startReview('<%= application.id %>')" class="action-btn primary">ğŸ“‹ Ø¨Ø¯Ø¡
                            Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
                          <% } %>
                            <% if (application.status==='under_review' ) { %><button
                                onclick="approveApplication('<%= application.id %>')" class="action-btn success">âœ… Ù‚Ø¨ÙˆÙ„
                                Ø§Ù„Ø·Ù„Ø¨</button><button onclick="showRejectModal('<%= application.id %>')"
                                class="action-btn danger">âŒ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</button>
                              <% } %>
                                <% if (application.status==='approved_payment_pending' ) { %>
                                  <div class="notice-box warning">
                                    ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹
                                  </div>
                                  <button onclick="downloadSupplyOrder('<%= application.id %>')"
                                    class="action-btn outline">
                                    Ø·Ø¨Ø§Ø¹Ø© Ø£Ù…Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯
                                  </button>
                                  <% } %>
                                    <% if (application.status==='payment_verified' ) { %><button
                                        onclick="markReady('<%= application.id %>')" class="action-btn success">ğŸ“¦
                                        Ø§Ù„Ø±Ø®ØµØ©
                                        Ø¬Ø§Ù‡Ø²Ø©</button>
                                      <div class="notice-box success">ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹</div>
                                      <% } %>
                                        <% if (application.status==='ready' ) { %><button
                                            onclick="completeApplication('<%= application.id %>')"
                                            class="action-btn success">ğŸ‰ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
                                          <div class="notice-box success">Ø§Ù„Ø±Ø®ØµØ© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…</div>
                                          <% } %>
                                            <% if (application.status==='completed' ) { %>
                                              <div class="notice-box success"
                                                style="text-align: center; font-weight: 600;">âœ¨
                                                ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„ØªØ±Ø®ÙŠØµ</div><button
                                                onclick="printLicense('<%= application.id %>')"
                                                class="action-btn outline">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>
                                              <% } %>
                                                <% if (application.status==='rejected' ) { %>
                                                  <div class="notice-box error"
                                                    style="text-align: center; font-weight: 600;">
                                                    âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</div>
                                                  <% } %>
                      </div>
                    </div>

                    <% if (application.paymentAmount) { %>
                      <div class="detail-card">
                        <div class="detail-card-body" style="text-align: center;">
                          <p style="color: #757575; font-size: 0.875rem;">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ø³ÙˆÙ…</p>
                          <p style="font-size: 1.75rem; font-weight: 700; color: #00796b;">
                            <%= application.paymentAmount %> Ø¬.Ù…
                          </p>
                        </div>
                      </div>
                      <% } %>
            </div>
          </div>
        </div>
      </div>

      <div id="rejectModal" class="modal-overlay">
        <div class="modal">
          <h3 style="font-weight: 700; margin-bottom: 1rem;">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</h3>
          <textarea id="rejectReason" rows="4" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶..."
            style="width: 100%; margin-bottom: 1rem;"></textarea>
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="confirmReject()" class="action-btn danger" style="flex: 1;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶</button>
            <button onclick="hideRejectModal()" class="action-btn outline" style="flex: 1;">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      </div>

      <%- include('../partials/footer') %>

        <script>
          var currentRejectId = null;
          var api = axios.create({ baseURL: '/api/v1', withCredentials: true });

          function startReview(id) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
            api.put('/admin/applications/' + id + '/review').then(function (res) { if (res.data.status === 'success') location.reload(); }).catch(function (err) { alert(err.response?.data?.message || 'Ø®Ø·Ø£'); });
          }
          function approveApplication(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
            api.post('/admin/applications/' + id + '/approve').then(function (res) { if (res.data.status === 'success') location.reload(); }).catch(function (err) { alert(err.response?.data?.message || 'Ø®Ø·Ø£'); });
          }
          function showRejectModal(id) { currentRejectId = id; document.getElementById('rejectModal').style.display = 'flex'; }
          function hideRejectModal() { currentRejectId = null; document.getElementById('rejectModal').style.display = 'none'; document.getElementById('rejectReason').value = ''; }
          function confirmReject() {
            var reason = document.getElementById('rejectReason').value.trim();
            if (!reason) { alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶'); return; }
            api.post('/admin/applications/' + currentRejectId + '/reject', { reason: reason }).then(function (res) { if (res.data.status === 'success') location.reload(); }).catch(function (err) { alert(err.response?.data?.message || 'Ø®Ø·Ø£'); });
          }
          function verifyPayment(id) {
            if (!confirm('Ù‡Ù„ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹ØŸ')) return;
            api.put('/admin/applications/' + id + '/verify-payment').then(function (res) { if (res.data.status === 'success') location.reload(); }).catch(function (err) { alert(err.response?.data?.message || 'Ø®Ø·Ø£'); });
          }
          function markReady(id) {
            if (!confirm('Ù‡Ù„ Ø§Ù„Ø±Ø®ØµØ© Ø¬Ø§Ù‡Ø²Ø©ØŸ')) return;
            api.put('/admin/applications/' + id + '/ready').then(function (res) { if (res.data.status === 'success') location.reload(); }).catch(function (err) { alert(err.response?.data?.message || 'Ø®Ø·Ø£'); });
          }
          function completeApplication(id) {
            if (!confirm('Ù‡Ù„ ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø±Ø®ØµØ©ØŸ')) return;
            api.put('/admin/applications/' + id + '/complete').then(function (res) { if (res.data.status === 'success') location.reload(); }).catch(function (err) { alert(err.response?.data?.message || 'Ø®Ø·Ø£'); });
          }
          function downloadSupplyOrder(id) {
            api.get('/admin/applications/' + id + '/supply-order').then(function (res) { if (res.data.status === 'success') { console.log('Supply order:', res.data.data); alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù…Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ø¬Ø§Ù‡Ø²Ø©'); } }).catch(function (err) { alert(err.response?.data?.message || 'Ø®Ø·Ø£'); });
          }
          function printLicense(id) {
            api.get('/admin/applications/' + id + '/license-pdf').then(function (res) { if (res.data.status === 'success') { console.log('License:', res.data.data); alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¬Ø§Ù‡Ø²Ø©'); } }).catch(function (err) { alert(err.response?.data?.message || 'Ø®Ø·Ø£'); });
          }
        </script>
</body>

</html>