<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %> - منصة تراخيص بحيرة البردويل
    </title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="icon" type="image/png" href="/imgs/logo.png">
</head>

<body>
    <%- include('../partials/spinner') %>
        <%- include('../partials/navbar') %>
            <%- include('../partials/admin-sidebar', { currentPage: 'news' , pendingCount: pendingCount || 0 }) %>

                <div class="admin-page">
                    <div class="container">
                        <!-- Header -->
                        <div class="page-header">
                            <div class="header-info">
                                <h1><i class="fas fa-newspaper"></i> إدارة الأخبار</h1>
                                <p>إضافة وتعديل وحذف الأخبار والإعلانات</p>
                            </div>
                            <button class="btn btn-primary" onclick="openCreateModal()">
                                <i class="fas fa-plus"></i> إضافة خبر جديد
                            </button>
                        </div>

                        <!-- Stats Cards -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-newspaper"></i></div>
                                <div class="stat-info">
                                    <h3>
                                        <%= stats.total %>
                                    </h3>
                                    <p>إجمالي الأخبار</p>
                                </div>
                            </div>
                            <div class="stat-card published">
                                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                                <div class="stat-info">
                                    <h3>
                                        <%= stats.published %>
                                    </h3>
                                    <p>منشورة</p>
                                </div>
                            </div>
                            <div class="stat-card draft">
                                <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                                <div class="stat-info">
                                    <h3>
                                        <%= stats.drafts %>
                                    </h3>
                                    <p>مسودات</p>
                                </div>
                            </div>
                        </div>

                        <!-- News Table -->
                        <div class="card">
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>العنوان</th>
                                            <th>الفئة</th>
                                            <th>الحالة</th>
                                            <th>المشاهدات</th>
                                            <th>تاريخ الإنشاء</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (news && news.length> 0) { %>
                                            <% news.forEach(item=> { %>
                                                <tr>
                                                    <td>
                                                        <div class="news-title">
                                                            <strong>
                                                                <%= item.titleAr %>
                                                            </strong>
                                                            <% if (item.isPinned) { %>
                                                                <span class="badge badge-warning"><i
                                                                        class="fas fa-thumbtack"></i></span>
                                                                <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="category-badge category-<%= item.category %>">
                                                            <%= item.category==='news' ? 'خبر' :
                                                                item.category==='announcement' ? 'إعلان' :
                                                                item.category==='update' ? 'تحديث' : 'تنبيه' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span
                                                            class="status-badge <%= item.isPublished ? 'published' : 'draft' %>">
                                                            <%= item.isPublished ? 'منشور' : 'مسودة' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <%= item.viewCount %>
                                                    </td>
                                                    <td>
                                                        <%= new Date(item.createdAt).toLocaleDateString('ar-EG') %>
                                                    </td>
                                                    <td>
                                                        <div class="action-btns">
                                                            <button class="btn-icon"
                                                                onclick="togglePublish('<%= item.id %>')"
                                                                title="<%= item.isPublished ? 'إلغاء النشر' : 'نشر' %>">
                                                                <i
                                                                    class="fas <%= item.isPublished ? 'fa-eye-slash' : 'fa-eye' %>"></i>
                                                            </button>
                                                            <button class="btn-icon"
                                                                onclick="editNews('<%= item.id %>')" title="تعديل">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="btn-icon delete"
                                                                onclick="deleteNews('<%= item.id %>')" title="حذف">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="6" class="empty-state">
                                                                <i class="fas fa-inbox"></i>
                                                                <p>لا توجد أخبار</p>
                                                            </td>
                                                        </tr>
                                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <% if (pagination.pages> 1) { %>
                                <div class="pagination">
                                    <% for (let i=1; i <=pagination.pages; i++) { %>
                                        <a href="?page=<%= i %>"
                                            class="page-link <%= pagination.page === i ? 'active' : '' %>">
                                            <%= i %>
                                        </a>
                                        <% } %>
                                </div>
                                <% } %>
                        </div>
                    </div>
                </div>

                <!-- Create/Edit Modal -->
                <div class="modal" id="newsModal">
                    <div class="modal-overlay" onclick="closeModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 id="modalTitle">إضافة خبر جديد</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <form id="newsForm">
                            <input type="hidden" id="newsId" name="id">
                            <div class="form-group">
                                <label>العنوان بالعربية *</label>
                                <input type="text" name="titleAr" id="titleAr" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>المحتوى بالعربية *</label>
                                <textarea name="contentAr" id="contentAr" class="form-control" rows="5"
                                    required></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>الفئة</label>
                                    <select name="category" id="category" class="form-control">
                                        <option value="news">خبر</option>
                                        <option value="announcement">إعلان</option>
                                        <option value="update">تحديث</option>
                                        <option value="alert">تنبيه</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="isPinned" id="isPinned">
                                        <span>تثبيت الخبر</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Image Upload Section -->
                            <div class="form-group">
                                <label>صورة الخبر</label>
                                <div class="image-upload-section">
                                    <div class="image-preview" id="imagePreview">
                                        <img id="previewImg" src="/imgs/news1.png" alt="Preview">
                                    </div>
                                    <div class="image-options">
                                        <div class="upload-option">
                                            <label class="btn btn-outline-secondary btn-sm">
                                                <i class="fas fa-upload"></i> رفع صورة
                                                <input type="file" id="imageFile" accept="image/*" hidden
                                                    onchange="previewImage(this)">
                                            </label>
                                        </div>
                                        <div class="default-images">
                                            <label>أو اختر صورة افتراضية:</label>
                                            <div class="default-grid">
                                                <img src="/imgs/news1.png" onclick="selectDefault('/imgs/news1.png')"
                                                    class="default-img selected">
                                                <img src="/imgs/news2.png" onclick="selectDefault('/imgs/news2.png')"
                                                    class="default-img">
                                                <img src="/imgs/news3.png" onclick="selectDefault('/imgs/news3.png')"
                                                    class="default-img">
                                                <img src="/imgs/hero.png" onclick="selectDefault('/imgs/hero.png')"
                                                    class="default-img">
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="imagePath" name="imagePath" value="/imgs/news1.png">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline-secondary"
                                    onclick="closeModal()">إلغاء</button>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <span class="btn-text">حفظ</span>
                                    <span class="btn-loading hidden"><i class="fas fa-spinner fa-spin"></i></span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <%- include('../partials/footer') %>

                    <style>
                        .admin-page {
                            padding: 2rem 0;
                            min-height: calc(100vh - 200px);
                            background: #fafafa;
                        }

                        .page-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 2rem;
                            flex-wrap: wrap;
                            gap: 1rem;
                        }

                        .header-info h1 {
                            font-size: 1.75rem;
                            font-weight: 700;
                            color: #212121;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        }

                        .header-info h1 i {
                            color: #1e3c72;
                        }

                        .header-info p {
                            color: #757575;
                        }

                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 1.5rem;
                            margin-bottom: 2rem;
                        }

                        .stat-card {
                            background: white;
                            border-radius: 12px;
                            padding: 1.5rem;
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
                        }

                        .stat-icon {
                            width: 50px;
                            height: 50px;
                            border-radius: 12px;
                            background: linear-gradient(135deg, #1e3c72, #2a5298);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 1.25rem;
                        }

                        .stat-card.published .stat-icon {
                            background: linear-gradient(135deg, #4caf50, #2e7d32);
                        }

                        .stat-card.draft .stat-icon {
                            background: linear-gradient(135deg, #ff9800, #f57c00);
                        }

                        .stat-info h3 {
                            font-size: 1.5rem;
                            font-weight: 700;
                            color: #212121;
                        }

                        .stat-info p {
                            color: #757575;
                            font-size: 0.9rem;
                        }

                        .card {
                            background: white;
                            border-radius: 12px;
                            padding: 1.5rem;
                            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
                        }

                        .data-table {
                            width: 100%;
                            border-collapse: collapse;
                        }

                        .data-table th,
                        .data-table td {
                            padding: 1rem;
                            text-align: right;
                            border-bottom: 1px solid #eee;
                        }

                        .data-table th {
                            background: #f5f5f5;
                            font-weight: 600;
                            color: #1e3c72;
                        }

                        .news-title {
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        }

                        .category-badge {
                            padding: 0.25rem 0.75rem;
                            border-radius: 20px;
                            font-size: 0.85rem;
                        }

                        .category-news {
                            background: #e3f2fd;
                            color: #1976d2;
                        }

                        .category-announcement {
                            background: #fff3e0;
                            color: #f57c00;
                        }

                        .category-update {
                            background: #e8f5e9;
                            color: #388e3c;
                        }

                        .category-alert {
                            background: #ffebee;
                            color: #d32f2f;
                        }

                        .status-badge {
                            padding: 0.25rem 0.75rem;
                            border-radius: 20px;
                            font-size: 0.85rem;
                        }

                        .status-badge.published {
                            background: #e8f5e9;
                            color: #2e7d32;
                        }

                        .status-badge.draft {
                            background: #fff3e0;
                            color: #f57c00;
                        }

                        .action-btns {
                            display: flex;
                            gap: 0.5rem;
                        }

                        .btn-icon {
                            width: 36px;
                            height: 36px;
                            border-radius: 8px;
                            border: none;
                            background: #f5f5f5;
                            color: #757575;
                            cursor: pointer;
                            transition: all 0.2s;
                        }

                        .btn-icon:hover {
                            background: #1e3c72;
                            color: white;
                        }

                        .btn-icon.delete:hover {
                            background: #f44336;
                        }

                        .empty-state {
                            text-align: center;
                            padding: 3rem;
                            color: #9e9e9e;
                        }

                        .empty-state i {
                            font-size: 3rem;
                            margin-bottom: 1rem;
                        }

                        .pagination {
                            display: flex;
                            justify-content: center;
                            gap: 0.5rem;
                            margin-top: 1.5rem;
                        }

                        .page-link {
                            padding: 0.5rem 1rem;
                            border-radius: 8px;
                            background: #f5f5f5;
                            color: #1e3c72;
                            text-decoration: none;
                        }

                        .page-link.active {
                            background: #1e3c72;
                            color: white;
                        }

                        .modal {
                            position: fixed;
                            inset: 0;
                            z-index: 1000;
                            display: none;
                            align-items: center;
                            justify-content: center;
                        }

                        .modal.show {
                            display: flex;
                        }

                        .modal-overlay {
                            position: absolute;
                            inset: 0;
                            background: rgba(0, 0, 0, 0.5);
                        }

                        .modal-content {
                            position: relative;
                            background: white;
                            border-radius: 16px;
                            width: 90%;
                            max-width: 600px;
                            max-height: 90vh;
                            overflow-y: auto;
                        }

                        .modal-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border-bottom: 1px solid #eee;
                        }

                        .modal-header h2 {
                            font-size: 1.25rem;
                            font-weight: 700;
                            color: #212121;
                        }

                        .modal-close {
                            background: none;
                            border: none;
                            font-size: 1.25rem;
                            color: #757575;
                            cursor: pointer;
                        }

                        #newsForm {
                            padding: 1.5rem;
                        }

                        .form-row {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 1rem;
                        }

                        .form-actions {
                            display: flex;
                            justify-content: flex-end;
                            gap: 1rem;
                            margin-top: 1.5rem;
                        }

                        /* Image Upload Section */
                        .image-upload-section {
                            border: 2px dashed #e0e0e0;
                            border-radius: 12px;
                            padding: 1rem;
                            background: #fafafa;
                        }

                        .image-preview {
                            width: 100%;
                            height: 150px;
                            border-radius: 8px;
                            overflow: hidden;
                            margin-bottom: 1rem;
                            background: #f5f5f5;
                        }

                        .image-preview img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }

                        .image-options {
                            display: flex;
                            flex-direction: column;
                            gap: 1rem;
                        }

                        .upload-option {
                            text-align: center;
                        }

                        .default-images label {
                            font-size: 0.875rem;
                            color: #757575;
                            display: block;
                            margin-bottom: 0.5rem;
                        }

                        .default-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 0.5rem;
                        }

                        .default-img {
                            width: 100%;
                            height: 50px;
                            object-fit: cover;
                            border-radius: 6px;
                            cursor: pointer;
                            border: 2px solid transparent;
                            transition: all 0.2s;
                        }

                        .default-img:hover {
                            border-color: #1e3c72;
                            transform: scale(1.05);
                        }

                        .default-img.selected {
                            border-color: #4caf50;
                            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
                        }
                    </style>

                    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
                    <script src="/js/main.js"></script>
                    <script>
                        function openCreateModal() {
                            document.getElementById('modalTitle').textContent = 'إضافة خبر جديد';
                            document.getElementById('newsForm').reset();
                            document.getElementById('newsId').value = '';
                            document.getElementById('newsModal').classList.add('show');
                        }

                        function closeModal() {
                            document.getElementById('newsModal').classList.remove('show');
                        }

                        async function editNews(id) {
                            try {
                                const res = await axios.get(`/api/v1/admin/news/${id}`);
                                const news = res.data.data.news;
                                document.getElementById('modalTitle').textContent = 'تعديل الخبر';
                                document.getElementById('newsId').value = id;
                                document.getElementById('titleAr').value = news.titleAr;
                                document.getElementById('contentAr').value = news.contentAr;
                                document.getElementById('category').value = news.category;
                                document.getElementById('isPinned').checked = news.isPinned;
                                document.getElementById('newsModal').classList.add('show');
                            } catch (err) {
                                alert('حدث خطأ أثناء تحميل بيانات الخبر');
                            }
                        }

                        async function deleteNews(id) {
                            if (!confirm('هل أنت متأكد من حذف هذا الخبر؟')) return;
                            try {
                                await axios.delete(`/api/v1/admin/news/${id}`);
                                window.location.reload();
                            } catch (err) {
                                alert('حدث خطأ أثناء حذف الخبر');
                            }
                        }

                        async function togglePublish(id) {
                            try {
                                await axios.patch(`/api/v1/admin/news/${id}/publish`);
                                window.location.reload();
                            } catch (err) {
                                alert('حدث خطأ أثناء تحديث حالة النشر');
                            }
                        }

                        document.getElementById('newsForm').addEventListener('submit', async function (e) {
                            e.preventDefault();
                            const id = document.getElementById('newsId').value;
                            const btn = document.getElementById('submitBtn');
                            btn.disabled = true;

                            // Use FormData to support file upload
                            const formData = new FormData();
                            formData.append('titleAr', document.getElementById('titleAr').value);
                            formData.append('contentAr', document.getElementById('contentAr').value);
                            formData.append('category', document.getElementById('category').value);
                            formData.append('isPinned', document.getElementById('isPinned').checked);
                            
                            // Check if a file is selected for upload
                            const fileInput = document.getElementById('imageFile');
                            if (fileInput.files && fileInput.files[0]) {
                                formData.append('image', fileInput.files[0]);
                            } else {
                                // No file uploaded - send the default image path
                                const imagePath = document.getElementById('imagePath').value;
                                if (imagePath) {
                                    formData.append('imagePath', imagePath);
                                }
                            }

                            try {
                                const config = {
                                    headers: { 'Content-Type': 'multipart/form-data' }
                                };
                                if (id) {
                                    await axios.put(`/api/v1/admin/news/${id}`, formData, config);
                                } else {
                                    await axios.post('/api/v1/admin/news', formData, config);
                                }
                                window.location.reload();
                            } catch (err) {
                                alert(err.response?.data?.message || 'حدث خطأ أثناء حفظ الخبر');
                            } finally {
                                btn.disabled = false;
                            }
                        });

                        // Image handling functions
                        function previewImage(input) {
                            if (input.files && input.files[0]) {
                                const reader = new FileReader();
                                reader.onload = function (e) {
                                    document.getElementById('previewImg').src = e.target.result;
                                    // For now, use default path until file upload API is implemented
                                    document.getElementById('imagePath').value = '/imgs/news1.png';
                                    clearDefaultSelection();
                                };
                                reader.readAsDataURL(input.files[0]);
                            }
                        }

                        function selectDefault(path) {
                            document.getElementById('previewImg').src = path;
                            document.getElementById('imagePath').value = path;
                            clearDefaultSelection();
                            event.target.classList.add('selected');
                        }

                        function clearDefaultSelection() {
                            document.querySelectorAll('.default-img').forEach(img => img.classList.remove('selected'));
                        }

                        // Update editNews to load image
                        const originalEditNews = editNews;
                        editNews = async function (id) {
                            await originalEditNews(id);
                            // After modal opens, update image if available
                            try {
                                const res = await axios.get(`/api/v1/admin/news/${id}`);
                                const news = res.data.data.news;
                                if (news.imagePath) {
                                    document.getElementById('previewImg').src = news.imagePath;
                                    document.getElementById('imagePath').value = news.imagePath;
                                    clearDefaultSelection();
                                    document.querySelectorAll('.default-img').forEach(img => {
                                        if (img.src.includes(news.imagePath)) img.classList.add('selected');
                                    });
                                }
                            } catch (err) { }
                        };
                    </script>
</body>

</html>