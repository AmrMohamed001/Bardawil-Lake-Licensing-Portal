<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    <%= title || 'إدارة الطلبات' %> - منصة تراخيص بحيرة البردويل
  </title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="icon" type="image/png" href="/imgs/logo.png" />
</head>

<body>
  <%- include('../partials/spinner') %>
    <%- include('../partials/navbar') %>
      <%- include('../partials/admin-sidebar', { currentPage: 'applications' , pendingCount: pendingCount || 0 }) %>

        <div class="admin-applications-page">
          <div class="container">
            <!-- Page Header -->
            <div class="page-header">
              <div class="header-content">
                <h1><i class="fas fa-folder-open"></i> إدارة الطلبات</h1>
                <p>عرض ومراجعة جميع طلبات التراخيص</p>
              </div>
              <div class="header-actions">
                <a href="/admin-dashboard" class="btn btn-outline-primary">
                  <i class="fas fa-arrow-right"></i> لوحة التحكم
                </a>
              </div>
            </div>

            <!-- Filters -->
            <div class="filters-section">
              <form id="filterForm" action="/admin/applications" method="GET" class="filters-row">
                <div class="filter-group">
                  <label><i class="fas fa-filter"></i> الحالة</label>
                  <select name="status" class="form-control filter-auto">
                    <option value="">جميع الحالات</option>
                    <option value="received" <%=query?.status==='received' ? 'selected' : '' %>>تم الاستلام</option>
                    <option value="under_review" <%=query?.status==='under_review' ? 'selected' : '' %>>قيد المراجعة
                    </option>
                    <option value="approved_payment_pending" <%=query?.status==='approved_payment_pending' ? 'selected'
                      : '' %>>بانتظار الدفع</option>
                    <option value="payment_verified" <%=query?.status==='payment_verified' ? 'selected' : '' %>>تم الدفع
                    </option>
                    <option value="ready" <%=query?.status==='ready' ? 'selected' : '' %>>جاهز للاستلام</option>
                    <option value="completed" <%=query?.status==='completed' ? 'selected' : '' %>>مكتمل</option>
                    <option value="rejected" <%=query?.status==='rejected' ? 'selected' : '' %>>مرفوض</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label><i class="fas fa-tag"></i> النوع</label>
                  <select name="type" class="form-control filter-auto">
                    <option value="">جميع الأنواع</option>
                    <option value="fisherman" <%=query?.type==='fisherman' ? 'selected' : '' %>>صياد</option>
                    <option value="boat" <%=query?.type==='boat' ? 'selected' : '' %>>مركب</option>
                    <option value="vehicle" <%=query?.type==='vehicle' ? 'selected' : '' %>>سيارة</option>
                    <option value="other" <%=query?.type==='other' ? 'selected' : '' %>>تراخيص أخرى</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label><i class="fas fa-calendar"></i> من تاريخ</label>
                  <input type="date" name="dateFrom" class="form-control filter-auto"
                    value="<%= query?.dateFrom || '' %>">
                </div>
                <div class="filter-group">
                  <label><i class="fas fa-calendar"></i> إلى تاريخ</label>
                  <input type="date" name="dateTo" class="form-control filter-auto" value="<%= query?.dateTo || '' %>">
                </div>
                <div class="filter-group" style="flex: 2;">
                  <label><i class="fas fa-search"></i> بحث</label>
                  <input type="text" id="searchInput" name="search" class="form-control"
                    placeholder="رقم الطلب، الاسم، الرقم القومي..." value="<%= query?.search || '' %>">
                </div>
                <div class="filter-group filter-button">
                  <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> بحث</button>
                </div>
              </form>
              <div class="export-buttons" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                <a href="/api/v1/admin/applications/export/excel?status=<%= query?.status || '' %>&type=<%= query?.type || '' %>&search=<%= query?.search || '' %>"
                  class="btn btn-success btn-sm">
                  <i class="fas fa-file-excel"></i> تصدير Excel
                </a>
              </div>
            </div>

            <!-- Applications Table -->
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>رقم الطلب</th>
                    <th>مقدم الطلب</th>
                    <th>النوع</th>
                    <th>الفئة</th>
                    <th>التاريخ</th>
                    <th>الحالة</th>
                    <th>الإجراء</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (applications && applications.length> 0) { %>
                    <% applications.forEach(app=> { %>
                      <tr>
                        <td class="application-number">#<%= app.applicationNumber %>
                        </td>
                        <td>
                          <div class="applicant-info">
                            <strong>
                              <%= app.applicant ? app.applicant.firstNameAr + ' ' + app.applicant.lastNameAr : '-' %>
                            </strong>
                            <small>
                              <%= app.applicant?.nationalId || '' %>
                            </small>
                          </div>
                        </td>
                        <td>
                          <% if (app.applicationType==='fisherman' ) { %>صياد
                            <% } else if (app.applicationType==='boat' ) { %>مركب
                              <% } else if (app.applicationType==='vehicle' ) { %>سيارة
                                <% } else if (app.applicationType==='trade' ) { %>تجارة
                                  <% } else if (app.applicationType==='entry' ) { %>دخول
                                    <% } else if (app.applicationType==='other' ) { %>تراخيص أخرى
                                      <% } else { %>
                                        <%= app.applicationType %>
                                          <% } %>
                        </td>
                        <td>
                          <%= app.licenseCategory %>
                        </td>
                        <td>
                          <%= new Date(app.createdAt).toLocaleDateString('ar-EG') %>
                        </td>
                        <td>
                          <%- include('../partials/status-badge', { status: app.status, statusInfo: app.statusInfo }) %>
                        </td>
                        <td>
                          <a href="/admin/application/<%= app.id %>" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye"></i> مراجعة
                          </a>
                        </td>
                      </tr>
                      <% }) %>
                        <% } else { %>
                          <tr>
                            <td colspan="7" class="empty-state">
                              <i class="fas fa-folder-open"></i>
                              <p>لا توجد طلبات</p>
                            </td>
                          </tr>
                          <% } %>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <% if (pagination && pagination.pages> 1) { %>
              <% const buildUrl=(page)=> {
                const params = new URLSearchParams();
                if (query?.status) params.set('status', query.status);
                if (query?.type) params.set('type', query.type);
                if (query?.search) params.set('search', query.search);
                params.set('page', page);
                return '?' + params.toString();
                }; %>
                <div class="pagination">
                  <% if (pagination.page> 1) { %>
                    <a href="<%= buildUrl(pagination.page - 1) %>" class="page-link">السابق</a>
                    <% } %>
                      <% for (let i=1; i <=Math.min(pagination.pages, 5); i++) { %>
                        <a href="<%= buildUrl(i) %>" class="page-link <%= i === pagination.page ? 'active' : '' %>">
                          <%= i %>
                        </a>
                        <% } %>
                          <% if (pagination.page < pagination.pages) { %>
                            <a href="<%= buildUrl(pagination.page + 1) %>" class="page-link">التالي</a>
                            <% } %>
                </div>
                <% } %>
          </div>
        </div>

        <%- include('../partials/footer') %>

          <style>
            .admin-applications-page {
              padding: 2rem 0;
              min-height: calc(100vh - 200px);
              background: #f5f7fa;
            }

            .page-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 2rem;
              flex-wrap: wrap;
              gap: 1rem;
            }

            .page-header h1 {
              font-size: 2rem;
              font-weight: 700;
              color: #212121;
              display: flex;
              align-items: center;
              gap: 0.75rem;
            }

            .page-header h1 i {
              color: #1e3c72;
            }

            .page-header p {
              color: #757575;
              margin-top: 0.5rem;
            }

            /* Filters */
            .filters-section {
              background: white;
              border-radius: 12px;
              padding: 1.5rem;
              margin-bottom: 1.5rem;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            .filters-row {
              display: flex;
              gap: 1rem;
              flex-wrap: wrap;
              align-items: flex-end;
            }

            .filter-group {
              flex: 1;
              min-width: 150px;
            }

            .filter-group label {
              display: block;
              font-size: 0.875rem;
              font-weight: 600;
              color: #424242;
              margin-bottom: 0.5rem;
            }

            .filter-group label i {
              margin-left: 0.25rem;
              color: #1e3c72;
            }

            .filter-button {
              flex: 0 0 auto;
            }

            /* Table */
            .table-container {
              background: white;
              border-radius: 12px;
              overflow: hidden;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            .data-table {
              width: 100%;
              border-collapse: collapse;
            }

            .data-table th,
            .data-table td {
              padding: 1rem;
              text-align: right;
              border-bottom: 1px solid #eee;
            }

            .data-table th {
              background: #f8f9fa;
              font-weight: 600;
              color: #424242;
            }

            .data-table tbody tr:hover {
              background: #f8f9fa;
            }

            .application-number {
              font-weight: 600;
              color: #1e3c72;
            }

            .applicant-info strong {
              display: block;
              color: #212121;
            }

            .applicant-info small {
              color: #9e9e9e;
              font-size: 0.75rem;
            }

            .status-badge {
              padding: 0.25rem 0.75rem;
              border-radius: 20px;
              font-size: 0.75rem;
              font-weight: 600;
            }

            .status-badge.pending {
              background: #fff3e0;
              color: #f57c00;
            }

            .status-badge.review {
              background: #e3f2fd;
              color: #1976d2;
            }

            .status-badge.payment {
              background: #fce4ec;
              color: #c2185b;
            }

            .status-badge.verified {
              background: #e8f5e9;
              color: #2e7d32;
            }

            .status-badge.ready {
              background: #e0f2f1;
              color: #00796b;
            }

            .status-badge.completed {
              background: #c8e6c9;
              color: #1b5e20;
            }

            .status-badge.rejected {
              background: #ffebee;
              color: #c62828;
            }

            .btn-sm {
              padding: 0.375rem 0.75rem;
              font-size: 0.875rem;
            }

            .empty-state {
              text-align: center;
              padding: 3rem;
              color: #9e9e9e;
            }

            .empty-state i {
              font-size: 3rem;
              margin-bottom: 1rem;
              display: block;
            }

            /* Pagination */
            .pagination {
              display: flex;
              justify-content: center;
              gap: 0.5rem;
              margin-top: 1.5rem;
            }

            .page-link {
              padding: 0.5rem 1rem;
              border-radius: 8px;
              background: white;
              color: #424242;
              text-decoration: none;
              border: 1px solid #e0e0e0;
              transition: all 0.3s ease;
            }

            .page-link:hover,
            .page-link.active {
              background: #1e3c72;
              color: white;
              border-color: #1e3c72;
            }

            @media (max-width: 768px) {

              .data-table th:nth-child(4),
              .data-table td:nth-child(4),
              .data-table th:nth-child(5),
              .data-table td:nth-child(5) {
                display: none;
              }
            }
          </style>

          <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
          <script>
            // Auto-submit on filter change
            document.querySelectorAll('.filter-auto').forEach(function (el) {
              el.addEventListener('change', function () {
                document.getElementById('filterForm').submit();
              });
            });

            // Debounced search on typing
            var searchTimeout;
            document.getElementById('searchInput').addEventListener('input', function () {
              clearTimeout(searchTimeout);
              searchTimeout = setTimeout(function () {
                document.getElementById('filterForm').submit();
              }, 500);
            });
          </script>
</body>

</html>